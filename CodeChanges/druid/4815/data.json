{
  "url": "https://api.github.com/repos/apache/druid/pulls/4815",
  "id": 141462322,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTQxNDYyMzIy",
  "html_url": "https://github.com/apache/druid/pull/4815",
  "diff_url": "https://github.com/apache/druid/pull/4815.diff",
  "patch_url": "https://github.com/apache/druid/pull/4815.patch",
  "issue_url": "https://api.github.com/repos/apache/druid/issues/4815",
  "number": 4815,
  "state": "closed",
  "locked": false,
  "title": "Kafka Index Task that supports Incremental handoffs",
  "user": {
    "login": "pjain1",
    "id": 11787983,
    "node_id": "MDQ6VXNlcjExNzg3OTgz",
    "avatar_url": "https://avatars.githubusercontent.com/u/11787983?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pjain1",
    "html_url": "https://github.com/pjain1",
    "followers_url": "https://api.github.com/users/pjain1/followers",
    "following_url": "https://api.github.com/users/pjain1/following{/other_user}",
    "gists_url": "https://api.github.com/users/pjain1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pjain1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pjain1/subscriptions",
    "organizations_url": "https://api.github.com/users/pjain1/orgs",
    "repos_url": "https://api.github.com/users/pjain1/repos",
    "events_url": "https://api.github.com/users/pjain1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pjain1/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "Hopefully fixes #4016, #4177, #4812, #4781, #4743 and #5046 \r\nPartially fixes #4498 and #4693 \r\nAlternate to https://github.com/druid-io/druid/pull/4178 and https://github.com/druid-io/druid/pull/4175\r\n\r\n- Incrementally handoff segments when they hit maxRowsPerSegment limit\r\n- Decouple segment partitioning from Kafka partitioning, all records from consumed partitions go to a single druid segment\r\n- Support for restoring task on middle manager restarts by check pointing end offsets for segments\r\n- Incremental handoff is NOT supported with `pauseAfterRead` feature\r\n\r\nDesign - \r\n- Currently a KafkaIndexTask only creates and publishes segments corresponding to a single `sequenceName`.\r\n- With this PR, Introduced ability to incrementally hand-off segments by by starting a new sequence when `maxRowsInSegment` limit is reached and publishing all the segments for the previous sequence.\r\n- New Sequences are created by concatenating base sequence name with monotonically increasing id called `sequenceId`. It starts with 0.\r\n- A sequence corresponds to a range of Kafka offsets. `SequenceMetadata` class is added to `KafkaIndexTask` class to maintain metadata about a sequence. Metadata for all the sequences in the task is persisted to disk whenever a new sequence is created or deleted or end offsets for a sequence are set. This also enables restore on restart.\r\n- End offsets for the latest sequence is set whenever `AppenderatorDriverAddResult.getNumRowsInSegment()` returned by `add` call of `AppenderatorDriver` is greater than `maxRowsInMemory`. \r\n-At this point the task will pause and send `CheckPointDataSourceMetadataAction` to the Supervisor, which will use the same logic as is used for finishing all the tasks in the `TaskGroup` and call `setEndOffsets` on the replica tasks with `finish` flag set to `false` to indicate that current sequence should be finished and published and new sequence should be created for messages having offsets greater than the set end offsets. The new checkpoint information will be stored in the TaskGroup. \r\n- At Supervisor list of SequenceMetadata is not maintained for tasks in TaskGroup rather a sorted map of <SequenceId, Checkpoint> is maintained. Checkpoint always corresponds to the start offsets of a Sequence.\r\n- Whenever a new task is started by the Supervisor it always sends the map of checkpoints for the TaskGroup in the `context` field. Using this checkpoints information, the task creates list of SequenceMetadata and sets it start offsets to the start offset of the first sequence.\r\n- Since task always starts consuming from the start offset of first sequence, it is necessary for the Supervisor to remove checkpoints from the TaskGroup for which segments have been published so that new tasks are not sent stale checkpoints thus preventing duplicate work. \r\n- Supervisor does this clean up lazily only when it starts new tasks in replacement of a failed task or creates a new TaskGroup or discover new tasks for a TaskGroup (includes the case when it restarts). This is done by getting checkpoints information from the running tasks and verifying them with the offsets information in the metadata store. It also kills inconsistent task, refer to `verifyAndMergeCheckpoints` method.\r\n\r\nSome more information about specific issues -\r\n- Task status is set to `FINISHING` immediately after the task is asked to finish by call to `setEndOffsets` with `finish` set to `true` to fix https://github.com/druid-io/druid/issues/4812\r\n- To persist commit metadata only for the subset of segments which are being published, option 1 is used as described here - https://github.com/druid-io/druid/issues/4781\r\n- Un-deprecated `handoffConditionTimeout` property as for fixing https://github.com/druid-io/druid/pull/4175 the tasks are now killed (not stopped) after pending Completion Timeout elapses.\r\n",
  "created_at": "2017-09-16T21:15:08Z",
  "updated_at": "2018-10-18T20:54:50Z",
  "closed_at": "2017-11-17T22:05:21Z",
  "merged_at": "2017-11-17T22:05:21Z",
  "merge_commit_sha": "cb03efeb147135440656149f119fdedb489b4a9e",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 297508895,
      "node_id": "MDU6TGFiZWwyOTc1MDg4OTU=",
      "url": "https://api.github.com/repos/apache/druid/labels/Release%20Notes",
      "name": "Release Notes",
      "color": "006b75",
      "default": false,
      "description": null
    },
    {
      "id": 690563043,
      "node_id": "MDU6TGFiZWw2OTA1NjMwNDM=",
      "url": "https://api.github.com/repos/apache/druid/labels/Area%20-%20Streaming%20Ingestion",
      "name": "Area - Streaming Ingestion",
      "color": "fef2c0",
      "default": false,
      "description": ""
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/apache/druid/milestones/24",
    "html_url": "https://github.com/apache/druid/milestone/24",
    "labels_url": "https://api.github.com/repos/apache/druid/milestones/24/labels",
    "id": 2781414,
    "node_id": "MDk6TWlsZXN0b25lMjc4MTQxNA==",
    "number": 24,
    "title": "0.12.0",
    "description": "",
    "creator": {
      "login": "jon-wei",
      "id": 8729063,
      "node_id": "MDQ6VXNlcjg3MjkwNjM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8729063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jon-wei",
      "html_url": "https://github.com/jon-wei",
      "followers_url": "https://api.github.com/users/jon-wei/followers",
      "following_url": "https://api.github.com/users/jon-wei/following{/other_user}",
      "gists_url": "https://api.github.com/users/jon-wei/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jon-wei/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jon-wei/subscriptions",
      "organizations_url": "https://api.github.com/users/jon-wei/orgs",
      "repos_url": "https://api.github.com/users/jon-wei/repos",
      "events_url": "https://api.github.com/users/jon-wei/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jon-wei/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 203,
    "state": "closed",
    "created_at": "2017-09-20T20:11:45Z",
    "updated_at": "2018-10-08T22:02:59Z",
    "due_on": null,
    "closed_at": "2018-03-13T21:58:49Z"
  },
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/druid/pulls/4815/commits",
  "review_comments_url": "https://api.github.com/repos/apache/druid/pulls/4815/comments",
  "review_comment_url": "https://api.github.com/repos/apache/druid/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/druid/issues/4815/comments",
  "statuses_url": "https://api.github.com/repos/apache/druid/statuses/4335dc622edb15df85bd7f98d41c085936eafafa",
  "head": {
    "label": "pjain1:kafka_idxng",
    "ref": "kafka_idxng",
    "sha": "4335dc622edb15df85bd7f98d41c085936eafafa",
    "user": {
      "login": "pjain1",
      "id": 11787983,
      "node_id": "MDQ6VXNlcjExNzg3OTgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/11787983?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pjain1",
      "html_url": "https://github.com/pjain1",
      "followers_url": "https://api.github.com/users/pjain1/followers",
      "following_url": "https://api.github.com/users/pjain1/following{/other_user}",
      "gists_url": "https://api.github.com/users/pjain1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pjain1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pjain1/subscriptions",
      "organizations_url": "https://api.github.com/users/pjain1/orgs",
      "repos_url": "https://api.github.com/users/pjain1/repos",
      "events_url": "https://api.github.com/users/pjain1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pjain1/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": null
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "590633c595c3af75d65c522377328e1ef39fd5e8",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 6358188,
      "node_id": "MDEwOlJlcG9zaXRvcnk2MzU4MTg4",
      "name": "druid",
      "full_name": "apache/druid",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/druid",
      "description": "Apache Druid: a high performance real-time analytics database.",
      "fork": false,
      "url": "https://api.github.com/repos/apache/druid",
      "forks_url": "https://api.github.com/repos/apache/druid/forks",
      "keys_url": "https://api.github.com/repos/apache/druid/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/druid/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/druid/teams",
      "hooks_url": "https://api.github.com/repos/apache/druid/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/druid/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/druid/events",
      "assignees_url": "https://api.github.com/repos/apache/druid/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/druid/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/druid/tags",
      "blobs_url": "https://api.github.com/repos/apache/druid/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/druid/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/druid/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/druid/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/druid/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/druid/languages",
      "stargazers_url": "https://api.github.com/repos/apache/druid/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/druid/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/druid/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/druid/subscription",
      "commits_url": "https://api.github.com/repos/apache/druid/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/druid/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/druid/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/druid/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/druid/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/druid/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/druid/merges",
      "archive_url": "https://api.github.com/repos/apache/druid/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/druid/downloads",
      "issues_url": "https://api.github.com/repos/apache/druid/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/druid/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/druid/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/druid/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/druid/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/druid/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/druid/deployments",
      "created_at": "2012-10-23T19:08:07Z",
      "updated_at": "2022-12-26T05:51:26Z",
      "pushed_at": "2022-12-23T15:15:30Z",
      "git_url": "git://github.com/apache/druid.git",
      "ssh_url": "git@github.com:apache/druid.git",
      "clone_url": "https://github.com/apache/druid.git",
      "svn_url": "https://github.com/apache/druid",
      "homepage": "https://druid.apache.org/",
      "size": 294251,
      "stargazers_count": 12288,
      "watchers_count": 12288,
      "language": "Java",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": true,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 3408,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1607,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "druid"
      ],
      "visibility": "public",
      "forks": 3408,
      "open_issues": 1607,
      "watchers": 12288,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/druid/pulls/4815"
    },
    "html": {
      "href": "https://github.com/apache/druid/pull/4815"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/druid/issues/4815"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/druid/issues/4815/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/druid/pulls/4815/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/druid/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/druid/pulls/4815/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/druid/statuses/4335dc622edb15df85bd7f98d41c085936eafafa"
    }
  },
  "author_association": "MEMBER",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": true,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": {
    "login": "himanshug",
    "id": 246308,
    "node_id": "MDQ6VXNlcjI0NjMwOA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/246308?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/himanshug",
    "html_url": "https://github.com/himanshug",
    "followers_url": "https://api.github.com/users/himanshug/followers",
    "following_url": "https://api.github.com/users/himanshug/following{/other_user}",
    "gists_url": "https://api.github.com/users/himanshug/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/himanshug/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/himanshug/subscriptions",
    "organizations_url": "https://api.github.com/users/himanshug/orgs",
    "repos_url": "https://api.github.com/users/himanshug/repos",
    "events_url": "https://api.github.com/users/himanshug/events{/privacy}",
    "received_events_url": "https://api.github.com/users/himanshug/received_events",
    "type": "User",
    "site_admin": false
  },
  "comments": 41,
  "review_comments": 80,
  "maintainer_can_modify": false,
  "commits": 14,
  "additions": 2599,
  "deletions": 486,
  "changed_files": 31
}