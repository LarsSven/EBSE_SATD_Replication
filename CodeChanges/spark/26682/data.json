{
  "url": "https://api.github.com/repos/apache/spark/pulls/26682",
  "id": 345871765,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MzQ1ODcxNzY1",
  "html_url": "https://github.com/apache/spark/pull/26682",
  "diff_url": "https://github.com/apache/spark/pull/26682.diff",
  "patch_url": "https://github.com/apache/spark/pull/26682.patch",
  "issue_url": "https://api.github.com/repos/apache/spark/issues/26682",
  "number": 26682,
  "state": "closed",
  "locked": false,
  "title": "[SPARK-29306][CORE] Stage Level Sched: Executors need to track what ResourceProfile they are created with ",
  "user": {
    "login": "tgravescs",
    "id": 4563792,
    "node_id": "MDQ6VXNlcjQ1NjM3OTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4563792?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tgravescs",
    "html_url": "https://github.com/tgravescs",
    "followers_url": "https://api.github.com/users/tgravescs/followers",
    "following_url": "https://api.github.com/users/tgravescs/following{/other_user}",
    "gists_url": "https://api.github.com/users/tgravescs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tgravescs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tgravescs/subscriptions",
    "organizations_url": "https://api.github.com/users/tgravescs/orgs",
    "repos_url": "https://api.github.com/users/tgravescs/repos",
    "events_url": "https://api.github.com/users/tgravescs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tgravescs/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "### What changes were proposed in this pull request?\r\n<!--\r\nPlease clarify what changes you are proposing. The purpose of this section is to outline the changes and how this PR fixes the issue. \r\nIf possible, please consider writing useful notes for better and faster reviews in your PR. See the examples below.\r\n  1. If you refactor some codes with changing classes, showing the class hierarchy will help reviewers.\r\n  2. If you fix some SQL features, you can provide some references of other DBMSes.\r\n  3. If there is design documentation, please add the link.\r\n  4. If there is a discussion in the mailing list, please add the link.\r\n-->\r\n\r\nThis is the second PR for the Stage Level Scheduling. This is adding in the necessary executor side changes:\r\n1) executors to know what ResourceProfile they should be using\r\n2) handle parsing the resource profile settings - these are not in the global configs\r\n3) then reporting back to the driver what resource profile it was started with.\r\n\r\nThis PR adds all the piping for YARN to pass the information all the way to executors, but it just uses the default ResourceProfile (which is the global applicatino level configs).\r\n\r\nAt a high level these changes include:\r\n1) adding a new --resourceProfileId option to the CoarseGrainedExecutorBackend\r\n2) Add the ResourceProfile settings to new internal confs that gets passed into the Executor\r\n3) Executor changes that use the resource profile id passed in to read the corresponding ResourceProfile confs and then parse those requests and discover resources as necessary\r\n4) Executor registers to Driver with the Resource profile id so that the ExecutorMonitor can track how many executor with each profile are running\r\n5) YARN side changes to show that passing the resource profile id and confs actually works. Just uses the DefaultResourceProfile for now.\r\n\r\nI also removed a check from the CoarseGrainedExecutorBackend that used to check to make sure there were task requirements before parsing any custom resource executor requests.  With the resource profiles this becomes much more expensive because we would then have to pass the task requests to each executor and the check was just a short cut and not really needed. It was much cleaner just to remove it.\r\n\r\nNote there were some changes to the ResourceProfile, ExecutorResourceRequests, and TaskResourceRequests in this PR as well because I discovered some issues with things not being immutable. That api now look like:\r\n\r\nval rpBuilder = new ResourceProfileBuilder()\r\nval ereq = new ExecutorResourceRequests()\r\nval treq = new TaskResourceRequests()\r\n\r\nereq.cores(2).memory(\"6g\").memoryOverhead(\"2g\").pysparkMemory(\"2g\").resource(\"gpu\", 2, \"/home/tgraves/getGpus\")\r\ntreq.cpus(2).resource(\"gpu\", 2)\r\n\r\nval resourceProfile = rpBuilder.require(ereq).require(treq).build\r\n\r\nThis makes is so that ResourceProfile is immutable and Spark can use it directly without worrying about the user changing it.\r\n\r\n\r\n### Why are the changes needed?\r\n<!--\r\nPlease clarify why the changes are needed. For instance,\r\n  1. If you propose a new API, clarify the use case for a new API.\r\n  2. If you fix a bug, you can clarify why it is a bug.\r\n-->\r\n\r\nThese changes are needed for the executor to report which ResourceProfile they are using so that ultimately the dynamic allocation manager can use that information to know how many with a profile are running and how many more it needs to request.  Its also needed to get the resource profile confs to the executor so that it can run the appropriate discovery script if needed.\r\n\r\n### Does this PR introduce any user-facing change?\r\n<!--\r\nIf yes, please clarify the previous behavior and the change this PR proposes - provide the console output, description and/or an example to show the behavior difference if possible.\r\nIf no, write 'No'.\r\n-->\r\n\r\nNo\r\n\r\n### How was this patch tested?\r\n<!--\r\nIf tests were added, say they were added here. Please make sure to add some test cases that check the changes thoroughly including negative and positive cases if possible.\r\nIf it was tested in a way different from regular unit tests, please clarify how you tested step by step, ideally copy and paste-able, so that other reviewers can test and check, and descendants can verify in the future.\r\nIf tests were not added, please describe why they were not added and/or why it was difficult to add.\r\n-->\r\nUnit tests and manually on YARN.",
  "created_at": "2019-11-26T18:15:47Z",
  "updated_at": "2020-02-03T22:15:46Z",
  "closed_at": "2020-01-17T14:16:33Z",
  "merged_at": null,
  "merge_commit_sha": "083bcbc33733003bec012a7d63e92b9a7e063698",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 1405801482,
      "node_id": "MDU6TGFiZWwxNDA1ODAxNDgy",
      "url": "https://api.github.com/repos/apache/spark/labels/SPARK%20CORE",
      "name": "SPARK CORE",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/spark/pulls/26682/commits",
  "review_comments_url": "https://api.github.com/repos/apache/spark/pulls/26682/comments",
  "review_comment_url": "https://api.github.com/repos/apache/spark/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/26682/comments",
  "statuses_url": "https://api.github.com/repos/apache/spark/statuses/75091102d6bd64a61fb903c8df3edf9ca047e879",
  "head": {
    "label": "tgravescs:SPARK-29306",
    "ref": "SPARK-29306",
    "sha": "75091102d6bd64a61fb903c8df3edf9ca047e879",
    "user": {
      "login": "tgravescs",
      "id": 4563792,
      "node_id": "MDQ6VXNlcjQ1NjM3OTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4563792?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tgravescs",
      "html_url": "https://github.com/tgravescs",
      "followers_url": "https://api.github.com/users/tgravescs/followers",
      "following_url": "https://api.github.com/users/tgravescs/following{/other_user}",
      "gists_url": "https://api.github.com/users/tgravescs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tgravescs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tgravescs/subscriptions",
      "organizations_url": "https://api.github.com/users/tgravescs/orgs",
      "repos_url": "https://api.github.com/users/tgravescs/repos",
      "events_url": "https://api.github.com/users/tgravescs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tgravescs/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 17249522,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNzI0OTUyMg==",
      "name": "spark",
      "full_name": "tgravescs/spark",
      "private": false,
      "owner": {
        "login": "tgravescs",
        "id": 4563792,
        "node_id": "MDQ6VXNlcjQ1NjM3OTI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4563792?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tgravescs",
        "html_url": "https://github.com/tgravescs",
        "followers_url": "https://api.github.com/users/tgravescs/followers",
        "following_url": "https://api.github.com/users/tgravescs/following{/other_user}",
        "gists_url": "https://api.github.com/users/tgravescs/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tgravescs/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tgravescs/subscriptions",
        "organizations_url": "https://api.github.com/users/tgravescs/orgs",
        "repos_url": "https://api.github.com/users/tgravescs/repos",
        "events_url": "https://api.github.com/users/tgravescs/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tgravescs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/tgravescs/spark",
      "description": "Mirror of Apache Spark",
      "fork": true,
      "url": "https://api.github.com/repos/tgravescs/spark",
      "forks_url": "https://api.github.com/repos/tgravescs/spark/forks",
      "keys_url": "https://api.github.com/repos/tgravescs/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/tgravescs/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/tgravescs/spark/teams",
      "hooks_url": "https://api.github.com/repos/tgravescs/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/tgravescs/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/tgravescs/spark/events",
      "assignees_url": "https://api.github.com/repos/tgravescs/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/tgravescs/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/tgravescs/spark/tags",
      "blobs_url": "https://api.github.com/repos/tgravescs/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/tgravescs/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/tgravescs/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/tgravescs/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/tgravescs/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/tgravescs/spark/languages",
      "stargazers_url": "https://api.github.com/repos/tgravescs/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/tgravescs/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/tgravescs/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/tgravescs/spark/subscription",
      "commits_url": "https://api.github.com/repos/tgravescs/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/tgravescs/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/tgravescs/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/tgravescs/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/tgravescs/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/tgravescs/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/tgravescs/spark/merges",
      "archive_url": "https://api.github.com/repos/tgravescs/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/tgravescs/spark/downloads",
      "issues_url": "https://api.github.com/repos/tgravescs/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/tgravescs/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/tgravescs/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/tgravescs/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/tgravescs/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/tgravescs/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/tgravescs/spark/deployments",
      "created_at": "2014-02-27T13:26:24Z",
      "updated_at": "2019-12-12T03:01:23Z",
      "pushed_at": "2022-10-19T17:53:37Z",
      "git_url": "git://github.com/tgravescs/spark.git",
      "ssh_url": "git@github.com:tgravescs/spark.git",
      "clone_url": "https://github.com/tgravescs/spark.git",
      "svn_url": "https://github.com/tgravescs/spark",
      "homepage": null,
      "size": 407716,
      "stargazers_count": 1,
      "watchers_count": 1,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 2,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 2,
      "watchers": 1,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "384899944b25cb0abf5e71f9cc2610fecad4e8f5",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 17165658,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNzE2NTY1OA==",
      "name": "spark",
      "full_name": "apache/spark",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/spark",
      "description": "Apache Spark - A unified analytics engine for large-scale data processing",
      "fork": false,
      "url": "https://api.github.com/repos/apache/spark",
      "forks_url": "https://api.github.com/repos/apache/spark/forks",
      "keys_url": "https://api.github.com/repos/apache/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/spark/teams",
      "hooks_url": "https://api.github.com/repos/apache/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/spark/events",
      "assignees_url": "https://api.github.com/repos/apache/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/spark/tags",
      "blobs_url": "https://api.github.com/repos/apache/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/spark/languages",
      "stargazers_url": "https://api.github.com/repos/apache/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/spark/subscription",
      "commits_url": "https://api.github.com/repos/apache/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/spark/merges",
      "archive_url": "https://api.github.com/repos/apache/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/spark/downloads",
      "issues_url": "https://api.github.com/repos/apache/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/spark/deployments",
      "created_at": "2014-02-25T08:00:08Z",
      "updated_at": "2022-12-27T00:03:36Z",
      "pushed_at": "2022-12-26T23:10:31Z",
      "git_url": "git://github.com/apache/spark.git",
      "ssh_url": "git@github.com:apache/spark.git",
      "clone_url": "https://github.com/apache/spark.git",
      "svn_url": "https://github.com/apache/spark",
      "homepage": "https://spark.apache.org/",
      "size": 451536,
      "stargazers_count": 34618,
      "watchers_count": 34618,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 26430,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 208,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "java",
        "jdbc",
        "python",
        "r",
        "scala",
        "spark",
        "sql"
      ],
      "visibility": "public",
      "forks": 26430,
      "open_issues": 208,
      "watchers": 34618,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/spark/pulls/26682"
    },
    "html": {
      "href": "https://github.com/apache/spark/pull/26682"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/spark/issues/26682"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/spark/issues/26682/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/spark/pulls/26682/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/spark/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/spark/pulls/26682/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/spark/statuses/75091102d6bd64a61fb903c8df3edf9ca047e879"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 59,
  "review_comments": 74,
  "maintainer_can_modify": false,
  "commits": 73,
  "additions": 755,
  "deletions": 335,
  "changed_files": 29
}