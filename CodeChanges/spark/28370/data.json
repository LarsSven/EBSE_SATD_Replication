{
  "url": "https://api.github.com/repos/apache/spark/pulls/28370",
  "id": 409509199,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NDA5NTA5MTk5",
  "html_url": "https://github.com/apache/spark/pull/28370",
  "diff_url": "https://github.com/apache/spark/pull/28370.diff",
  "patch_url": "https://github.com/apache/spark/pull/28370.patch",
  "issue_url": "https://api.github.com/repos/apache/spark/issues/28370",
  "number": 28370,
  "state": "closed",
  "locked": false,
  "title": "[SPARK-20732][CORE] Decommission cache blocks to other executors when an executor is decommissioned",
  "user": {
    "login": "prakharjain09",
    "id": 2551496,
    "node_id": "MDQ6VXNlcjI1NTE0OTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2551496?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prakharjain09",
    "html_url": "https://github.com/prakharjain09",
    "followers_url": "https://api.github.com/users/prakharjain09/followers",
    "following_url": "https://api.github.com/users/prakharjain09/following{/other_user}",
    "gists_url": "https://api.github.com/users/prakharjain09/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prakharjain09/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prakharjain09/subscriptions",
    "organizations_url": "https://api.github.com/users/prakharjain09/orgs",
    "repos_url": "https://api.github.com/users/prakharjain09/repos",
    "events_url": "https://api.github.com/users/prakharjain09/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prakharjain09/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "### What changes were proposed in this pull request?\r\nAfter changes in SPARK-20628, CoarseGrainedSchedulerBackend can decommission an executor and stop assigning new tasks on it. We should also decommission the corresponding blockmanagers in the same way. i.e. Move the cached RDD blocks from those executors to other active executors.\r\n\r\n### Why are the changes needed?\r\nWe need to gracefully decommission the block managers so that the underlying RDD cache blocks are not lost in case the executors are taken away forcefully after some timeout (because of spotloss/pre-emptible VM etc). Its good to save as much cache data as possible. \r\n\r\nAlso In future once the decommissioning signal comes from Cluster Manager (say YARN/Mesos etc), dynamic allocation + this change gives us opportunity to downscale the executors faster by making the executors free of cache data.\r\n\r\nNote that this is a best effort approach. We try to move cache blocks from decommissioning executors to active executors. If the active executors don't have free resources available on them for caching, then the decommissioning executors will keep the cache block which it was not able to move and it will still be able to serve them.\r\n\r\nCurrent overall Flow:\r\n\r\n1. CoarseGrainedSchedulerBackend receives a signal to decommissionExecutor. On receiving the signal, it do 2 things - Stop assigning new tasks (SPARK-20628), Send another message to BlockManagerMasterEndpoint (via BlockManagerMaster) to decommission the corresponding BlockManager.\r\n\r\n2. BlockManagerMasterEndpoint receives \"DecommissionBlockManagers\" message. On receiving this, it moves the corresponding block managers to \"decommissioning\" state. All decommissioning BMs are excluded from the getPeers RPC call which is used for replication. All these decommissioning BMs are also sent message from BlockManagerMasterEndpoint to start decommissioning process on themselves.\r\n\r\n3. BlockManager on worker (say BM-x) receives the \"DecommissionBlockManager\" message. Now it will start BlockManagerDecommissionManager thread to offload all the RDD cached blocks. This thread can make multiple reattempts to decommission the existing cache blocks (multiple reattempts might be needed as there might not be sufficient space in other active BMs initially).\r\n\r\n### Does this PR introduce any user-facing change?\r\nNO\r\n\r\n### How was this patch tested?\r\nAdded UTs.",
  "created_at": "2020-04-27T13:40:33Z",
  "updated_at": "2020-06-23T19:19:03Z",
  "closed_at": "2020-05-18T18:38:33Z",
  "merged_at": null,
  "merge_commit_sha": "ea87d07a6b4bedc50cdca1dfdc31a2484f10f29d",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 1406627200,
      "node_id": "MDU6TGFiZWwxNDA2NjI3MjAw",
      "url": "https://api.github.com/repos/apache/spark/labels/BUILD",
      "name": "BUILD",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1981527456,
      "node_id": "MDU6TGFiZWwxOTgxNTI3NDU2",
      "url": "https://api.github.com/repos/apache/spark/labels/CORE",
      "name": "CORE",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/spark/pulls/28370/commits",
  "review_comments_url": "https://api.github.com/repos/apache/spark/pulls/28370/comments",
  "review_comment_url": "https://api.github.com/repos/apache/spark/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/28370/comments",
  "statuses_url": "https://api.github.com/repos/apache/spark/statuses/c34305662cd91d05b5160c7de72e35e4108b6755",
  "head": {
    "label": "prakharjain09:SPARK-20732-rddcache-1",
    "ref": "SPARK-20732-rddcache-1",
    "sha": "c34305662cd91d05b5160c7de72e35e4108b6755",
    "user": {
      "login": "prakharjain09",
      "id": 2551496,
      "node_id": "MDQ6VXNlcjI1NTE0OTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2551496?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prakharjain09",
      "html_url": "https://github.com/prakharjain09",
      "followers_url": "https://api.github.com/users/prakharjain09/followers",
      "following_url": "https://api.github.com/users/prakharjain09/following{/other_user}",
      "gists_url": "https://api.github.com/users/prakharjain09/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prakharjain09/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prakharjain09/subscriptions",
      "organizations_url": "https://api.github.com/users/prakharjain09/orgs",
      "repos_url": "https://api.github.com/users/prakharjain09/repos",
      "events_url": "https://api.github.com/users/prakharjain09/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prakharjain09/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 140744137,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNDA3NDQxMzc=",
      "name": "spark",
      "full_name": "prakharjain09/spark",
      "private": false,
      "owner": {
        "login": "prakharjain09",
        "id": 2551496,
        "node_id": "MDQ6VXNlcjI1NTE0OTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2551496?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/prakharjain09",
        "html_url": "https://github.com/prakharjain09",
        "followers_url": "https://api.github.com/users/prakharjain09/followers",
        "following_url": "https://api.github.com/users/prakharjain09/following{/other_user}",
        "gists_url": "https://api.github.com/users/prakharjain09/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/prakharjain09/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/prakharjain09/subscriptions",
        "organizations_url": "https://api.github.com/users/prakharjain09/orgs",
        "repos_url": "https://api.github.com/users/prakharjain09/repos",
        "events_url": "https://api.github.com/users/prakharjain09/events{/privacy}",
        "received_events_url": "https://api.github.com/users/prakharjain09/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/prakharjain09/spark",
      "description": "Mirror of Apache Spark",
      "fork": true,
      "url": "https://api.github.com/repos/prakharjain09/spark",
      "forks_url": "https://api.github.com/repos/prakharjain09/spark/forks",
      "keys_url": "https://api.github.com/repos/prakharjain09/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/prakharjain09/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/prakharjain09/spark/teams",
      "hooks_url": "https://api.github.com/repos/prakharjain09/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/prakharjain09/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/prakharjain09/spark/events",
      "assignees_url": "https://api.github.com/repos/prakharjain09/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/prakharjain09/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/prakharjain09/spark/tags",
      "blobs_url": "https://api.github.com/repos/prakharjain09/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/prakharjain09/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/prakharjain09/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/prakharjain09/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/prakharjain09/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/prakharjain09/spark/languages",
      "stargazers_url": "https://api.github.com/repos/prakharjain09/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/prakharjain09/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/prakharjain09/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/prakharjain09/spark/subscription",
      "commits_url": "https://api.github.com/repos/prakharjain09/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/prakharjain09/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/prakharjain09/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/prakharjain09/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/prakharjain09/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/prakharjain09/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/prakharjain09/spark/merges",
      "archive_url": "https://api.github.com/repos/prakharjain09/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/prakharjain09/spark/downloads",
      "issues_url": "https://api.github.com/repos/prakharjain09/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/prakharjain09/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/prakharjain09/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/prakharjain09/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/prakharjain09/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/prakharjain09/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/prakharjain09/spark/deployments",
      "created_at": "2018-07-12T17:21:48Z",
      "updated_at": "2020-07-01T08:52:25Z",
      "pushed_at": "2020-12-15T06:49:26Z",
      "git_url": "git://github.com/prakharjain09/spark.git",
      "ssh_url": "git@github.com:prakharjain09/spark.git",
      "clone_url": "https://github.com/prakharjain09/spark.git",
      "svn_url": "https://github.com/prakharjain09/spark",
      "homepage": null,
      "size": 393511,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 0,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 0,
      "watchers": 0,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "735771e7b4f7c6dfe70a1a6f59b0646dcc6bacd7",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 17165658,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNzE2NTY1OA==",
      "name": "spark",
      "full_name": "apache/spark",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/spark",
      "description": "Apache Spark - A unified analytics engine for large-scale data processing",
      "fork": false,
      "url": "https://api.github.com/repos/apache/spark",
      "forks_url": "https://api.github.com/repos/apache/spark/forks",
      "keys_url": "https://api.github.com/repos/apache/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/spark/teams",
      "hooks_url": "https://api.github.com/repos/apache/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/spark/events",
      "assignees_url": "https://api.github.com/repos/apache/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/spark/tags",
      "blobs_url": "https://api.github.com/repos/apache/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/spark/languages",
      "stargazers_url": "https://api.github.com/repos/apache/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/spark/subscription",
      "commits_url": "https://api.github.com/repos/apache/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/spark/merges",
      "archive_url": "https://api.github.com/repos/apache/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/spark/downloads",
      "issues_url": "https://api.github.com/repos/apache/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/spark/deployments",
      "created_at": "2014-02-25T08:00:08Z",
      "updated_at": "2022-12-27T00:03:36Z",
      "pushed_at": "2022-12-26T23:10:31Z",
      "git_url": "git://github.com/apache/spark.git",
      "ssh_url": "git@github.com:apache/spark.git",
      "clone_url": "https://github.com/apache/spark.git",
      "svn_url": "https://github.com/apache/spark",
      "homepage": "https://spark.apache.org/",
      "size": 451536,
      "stargazers_count": 34618,
      "watchers_count": 34618,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 26430,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 208,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "java",
        "jdbc",
        "python",
        "r",
        "scala",
        "spark",
        "sql"
      ],
      "visibility": "public",
      "forks": 26430,
      "open_issues": 208,
      "watchers": 34618,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/spark/pulls/28370"
    },
    "html": {
      "href": "https://github.com/apache/spark/pull/28370"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/spark/issues/28370"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/spark/issues/28370/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/spark/pulls/28370/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/spark/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/spark/pulls/28370/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/spark/statuses/c34305662cd91d05b5160c7de72e35e4108b6755"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 69,
  "review_comments": 70,
  "maintainer_can_modify": false,
  "commits": 21,
  "additions": 409,
  "deletions": 13,
  "changed_files": 10
}