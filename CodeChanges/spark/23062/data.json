{
  "url": "https://api.github.com/repos/apache/spark/pulls/23062",
  "id": 231685780,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjMxNjg1Nzgw",
  "html_url": "https://github.com/apache/spark/pull/23062",
  "diff_url": "https://github.com/apache/spark/pull/23062.diff",
  "patch_url": "https://github.com/apache/spark/pull/23062.patch",
  "issue_url": "https://api.github.com/repos/apache/spark/issues/23062",
  "number": 23062,
  "state": "closed",
  "locked": false,
  "title": "[SPARK-8288][SQL] ScalaReflection can use companion object constructor",
  "user": {
    "login": "drewrobb",
    "id": 140935,
    "node_id": "MDQ6VXNlcjE0MDkzNQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/140935?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/drewrobb",
    "html_url": "https://github.com/drewrobb",
    "followers_url": "https://api.github.com/users/drewrobb/followers",
    "following_url": "https://api.github.com/users/drewrobb/following{/other_user}",
    "gists_url": "https://api.github.com/users/drewrobb/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/drewrobb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/drewrobb/subscriptions",
    "organizations_url": "https://api.github.com/users/drewrobb/orgs",
    "repos_url": "https://api.github.com/users/drewrobb/repos",
    "events_url": "https://api.github.com/users/drewrobb/events{/privacy}",
    "received_events_url": "https://api.github.com/users/drewrobb/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "## What changes were proposed in this pull request?\r\n\r\nThis change fixes a particular scenario where default spark SQL can't encode (thrift) types that are generated by twitter scrooge. These types are a trait that extends `scala.ProductX` with a constructor defined only in a companion object, rather than a actual case class. The actual case class used is child class, but that type is almost never referred to in code. The type has no corresponding constructor symbol and causes an exception. For all other purposes, these classes act just like case classes, so it is unfortunate that spark SQL can't serialize them nicely as it can actual case classes. For an full example of a scrooge codegen class, see https://gist.github.com/anonymous/ba13d4b612396ca72725eaa989900314.\r\n\r\nThis change catches the case where the type has no constructor but does have an `apply` method on the type's companion object. This allows for thrift types to be serialized/deserialized with implicit encoders the same way as normal case classes. This fix had to be done in three places where the constructor is assumed to be an actual constructor:\r\n\r\n1) In serializing, determining the schema for the dataframe relies on inspecting its constructor (`ScalaReflection.constructParams`). Here we fall back to using the companion constructor arguments.\r\n2) In deserializing or evaluating, in the java codegen ( `NewInstance.doGenCode`), the type couldn't be constructed with the new keyword. If there is no constructor, we change the constructor call to try the companion constructor.\r\n3)  In deserializing or evaluating, without codegen, the constructor is directly invoked (`NewInstance.constructor`). This was fixed with scala reflection to get the actual companion apply method.\r\n\r\nThe return type of `findConstructor` was changed because the companion apply method constructor can't be represented as a `java.lang.reflect.Constructor`.\r\n\r\nThere might be situations in which this approach would also fail in a new way, but it does at a minimum work for the specific scrooge example and will not impact cases that were already succeeding prior to this change\r\n\r\nNote: this fix does not enable using scrooge thrift enums, additional work for this is necessary. With this patch, it seems like you could patch `com.twitter.scrooge.ThriftEnum` to extend `_root_.scala.Product1[Int]` with `def _1 = value` to get spark's implicit encoders to handle enums, but I've yet to use this method myself.\r\n\r\nNote: I previously opened a PR for this issue, but only was able to fix case 1) there: https://github.com/apache/spark/pull/18766\r\n\r\n## How was this patch tested?\r\n\r\nI've fixed all 3 cases and added two tests that use a case class that is similar to scrooge generated one. The test in ScalaReflectionSuite checks 1), and the additional asserting in ObjectExpressionsSuite checks 2) and 3).\r\n",
  "created_at": "2018-11-16T23:46:52Z",
  "updated_at": "2018-11-21T15:42:46Z",
  "closed_at": "2018-11-21T15:42:46Z",
  "merged_at": null,
  "merge_commit_sha": "cb081971c3610bc812a4ffb4ec3e0130a6dd273d",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/spark/pulls/23062/commits",
  "review_comments_url": "https://api.github.com/repos/apache/spark/pulls/23062/comments",
  "review_comment_url": "https://api.github.com/repos/apache/spark/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/23062/comments",
  "statuses_url": "https://api.github.com/repos/apache/spark/statuses/04a34c4ee7c43120721659713fb8024e90282a0c",
  "head": {
    "label": "drewrobb:SPARK-8288",
    "ref": "SPARK-8288",
    "sha": "04a34c4ee7c43120721659713fb8024e90282a0c",
    "user": {
      "login": "drewrobb",
      "id": 140935,
      "node_id": "MDQ6VXNlcjE0MDkzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/140935?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/drewrobb",
      "html_url": "https://github.com/drewrobb",
      "followers_url": "https://api.github.com/users/drewrobb/followers",
      "following_url": "https://api.github.com/users/drewrobb/following{/other_user}",
      "gists_url": "https://api.github.com/users/drewrobb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/drewrobb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/drewrobb/subscriptions",
      "organizations_url": "https://api.github.com/users/drewrobb/orgs",
      "repos_url": "https://api.github.com/users/drewrobb/repos",
      "events_url": "https://api.github.com/users/drewrobb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/drewrobb/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 36042124,
      "node_id": "MDEwOlJlcG9zaXRvcnkzNjA0MjEyNA==",
      "name": "spark",
      "full_name": "drewrobb/spark",
      "private": false,
      "owner": {
        "login": "drewrobb",
        "id": 140935,
        "node_id": "MDQ6VXNlcjE0MDkzNQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/140935?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/drewrobb",
        "html_url": "https://github.com/drewrobb",
        "followers_url": "https://api.github.com/users/drewrobb/followers",
        "following_url": "https://api.github.com/users/drewrobb/following{/other_user}",
        "gists_url": "https://api.github.com/users/drewrobb/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/drewrobb/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/drewrobb/subscriptions",
        "organizations_url": "https://api.github.com/users/drewrobb/orgs",
        "repos_url": "https://api.github.com/users/drewrobb/repos",
        "events_url": "https://api.github.com/users/drewrobb/events{/privacy}",
        "received_events_url": "https://api.github.com/users/drewrobb/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/drewrobb/spark",
      "description": "Mirror of Apache Spark",
      "fork": true,
      "url": "https://api.github.com/repos/drewrobb/spark",
      "forks_url": "https://api.github.com/repos/drewrobb/spark/forks",
      "keys_url": "https://api.github.com/repos/drewrobb/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/drewrobb/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/drewrobb/spark/teams",
      "hooks_url": "https://api.github.com/repos/drewrobb/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/drewrobb/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/drewrobb/spark/events",
      "assignees_url": "https://api.github.com/repos/drewrobb/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/drewrobb/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/drewrobb/spark/tags",
      "blobs_url": "https://api.github.com/repos/drewrobb/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/drewrobb/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/drewrobb/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/drewrobb/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/drewrobb/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/drewrobb/spark/languages",
      "stargazers_url": "https://api.github.com/repos/drewrobb/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/drewrobb/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/drewrobb/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/drewrobb/spark/subscription",
      "commits_url": "https://api.github.com/repos/drewrobb/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/drewrobb/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/drewrobb/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/drewrobb/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/drewrobb/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/drewrobb/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/drewrobb/spark/merges",
      "archive_url": "https://api.github.com/repos/drewrobb/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/drewrobb/spark/downloads",
      "issues_url": "https://api.github.com/repos/drewrobb/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/drewrobb/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/drewrobb/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/drewrobb/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/drewrobb/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/drewrobb/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/drewrobb/spark/deployments",
      "created_at": "2015-05-21T23:24:37Z",
      "updated_at": "2018-11-16T19:27:54Z",
      "pushed_at": "2018-11-20T03:51:45Z",
      "git_url": "git://github.com/drewrobb/spark.git",
      "ssh_url": "git@github.com:drewrobb/spark.git",
      "clone_url": "https://github.com/drewrobb/spark.git",
      "svn_url": "https://github.com/drewrobb/spark",
      "homepage": null,
      "size": 264857,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 0,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 0,
      "watchers": 0,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "058c4602b000b24deb764a810ef8b43c41fe63ae",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 17165658,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNzE2NTY1OA==",
      "name": "spark",
      "full_name": "apache/spark",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/spark",
      "description": "Apache Spark - A unified analytics engine for large-scale data processing",
      "fork": false,
      "url": "https://api.github.com/repos/apache/spark",
      "forks_url": "https://api.github.com/repos/apache/spark/forks",
      "keys_url": "https://api.github.com/repos/apache/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/spark/teams",
      "hooks_url": "https://api.github.com/repos/apache/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/spark/events",
      "assignees_url": "https://api.github.com/repos/apache/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/spark/tags",
      "blobs_url": "https://api.github.com/repos/apache/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/spark/languages",
      "stargazers_url": "https://api.github.com/repos/apache/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/spark/subscription",
      "commits_url": "https://api.github.com/repos/apache/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/spark/merges",
      "archive_url": "https://api.github.com/repos/apache/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/spark/downloads",
      "issues_url": "https://api.github.com/repos/apache/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/spark/deployments",
      "created_at": "2014-02-25T08:00:08Z",
      "updated_at": "2022-12-26T21:18:49Z",
      "pushed_at": "2022-12-26T23:10:31Z",
      "git_url": "git://github.com/apache/spark.git",
      "ssh_url": "git@github.com:apache/spark.git",
      "clone_url": "https://github.com/apache/spark.git",
      "svn_url": "https://github.com/apache/spark",
      "homepage": "https://spark.apache.org/",
      "size": 451536,
      "stargazers_count": 34617,
      "watchers_count": 34617,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 26430,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 208,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "java",
        "jdbc",
        "python",
        "r",
        "scala",
        "spark",
        "sql"
      ],
      "visibility": "public",
      "forks": 26430,
      "open_issues": 208,
      "watchers": 34617,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/spark/pulls/23062"
    },
    "html": {
      "href": "https://github.com/apache/spark/pull/23062"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/spark/issues/23062"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/spark/issues/23062/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/spark/pulls/23062/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/spark/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/spark/pulls/23062/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/spark/statuses/04a34c4ee7c43120721659713fb8024e90282a0c"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 9,
  "review_comments": 38,
  "maintainer_can_modify": false,
  "commits": 7,
  "additions": 103,
  "deletions": 12,
  "changed_files": 5
}