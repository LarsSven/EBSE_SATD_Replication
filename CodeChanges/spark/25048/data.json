{
  "url": "https://api.github.com/repos/apache/spark/pulls/25048",
  "id": 294471035,
  "node_id": "MDExOlB1bGxSZXF1ZXN0Mjk0NDcxMDM1",
  "html_url": "https://github.com/apache/spark/pull/25048",
  "diff_url": "https://github.com/apache/spark/pull/25048.diff",
  "patch_url": "https://github.com/apache/spark/pull/25048.patch",
  "issue_url": "https://api.github.com/repos/apache/spark/issues/25048",
  "number": 25048,
  "state": "closed",
  "locked": false,
  "title": "[SPARK-28247][SS] Fix flaky test \"query without test harness\" on ContinuousSuite ",
  "user": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "## What changes were proposed in this pull request?\r\n\r\nThis patch fixes the flaky test \"query without test harness\" on ContinuousSuite, via adding some more gaps on waiting query to commit the epoch which writes output rows.\r\n\r\nThe observation of this issue is below (injected some debug logs to get them):\r\n\r\n```\r\nreader creation time                                   1562225320210\r\nepoch 1 launched                                       1562225320593 (+380ms from reader creation time)\r\nepoch 13 launched                                      1562225321702 (+1.5s from reader creation time)\r\npartition reader creation time                         1562225321715 (+1.5s from reader creation time)\r\n\r\nnext read time for first next call                     1562225321210 (+1s from reader creation time)\r\nfirst next called in partition reader                  1562225321746 (immediately after creation of partition reader)\r\nwait finished in next called in partition reader       1562225321746 (no wait)\r\n\r\nsecond next called in partition reader                 1562225321747 (immediately after first next())\r\n\r\nepoch 0 commit started                                 1562225321861\r\n\r\nwriting rows (0, 1) (belong to epoch 13)               1562225321866 (+100ms after first next())\r\n\r\nwait start in waitForRateSourceTriggers(2)             1562225322059\r\n\r\nnext read time for second next call                    1562225322210 (+1s from previous \"next read time\")\r\nwait finished in next called in partition reader       1562225322211 (+450ms wait)\r\n\r\nwriting rows (2, 3) (belong to epoch 13)               1562225322211 (immediately after next())\r\n\r\nepoch 14 launched                                      1562225322246\r\n\r\ndesired wait time in waitForRateSourceTriggers(2)      1562225322510 (+2.3s from reader creation time)\r\n\r\nepoch 12 committed                                     1562225323034\r\n```\r\n\r\nThese rows were written within desired wait time, but the epoch 13 couldn't be committed within it. Interestingly, epoch 12 was lucky to be committed within a gap between finished waiting in waitForRateSourceTriggers and query.stop() - but even suppose the rows were written in epoch 12, it would be just in luck and epoch should be committed within desired wait time.\r\n\r\nThis patch modifies Rate continuous stream to track the highest committed value, so that test can wait until desired value is reported to the stream as committed.\r\n\r\nThis patch also modifies Rate continuous stream to track the timestamp at stream gets the first committed offset, and let `waitForRateSourceTriggers` use the timestamp. This also relies on waiting for specific period, but safer approach compared to current based on the observation above. Based on the change, this patch saves couple of seconds in test time.\r\n\r\n## How was this patch tested?\r\n\r\n10 sequential test runs succeeded locally.",
  "created_at": "2019-07-04T08:15:51Z",
  "updated_at": "2019-07-15T01:11:54Z",
  "closed_at": "2019-07-13T17:16:01Z",
  "merged_at": null,
  "merge_commit_sha": "30073ce30db99b109c8297be063e83672c068901",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/spark/pulls/25048/commits",
  "review_comments_url": "https://api.github.com/repos/apache/spark/pulls/25048/comments",
  "review_comment_url": "https://api.github.com/repos/apache/spark/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/25048/comments",
  "statuses_url": "https://api.github.com/repos/apache/spark/statuses/6706a65ac2f7d7735332e7863c565e1994f5d431",
  "head": {
    "label": "HeartSaVioR:SPARK-28247",
    "ref": "SPARK-28247",
    "sha": "6706a65ac2f7d7735332e7863c565e1994f5d431",
    "user": {
      "login": "HeartSaVioR",
      "id": 1317309,
      "node_id": "MDQ6VXNlcjEzMTczMDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/HeartSaVioR",
      "html_url": "https://github.com/HeartSaVioR",
      "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
      "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
      "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
      "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
      "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
      "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
      "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 27994296,
      "node_id": "MDEwOlJlcG9zaXRvcnkyNzk5NDI5Ng==",
      "name": "spark",
      "full_name": "HeartSaVioR/spark",
      "private": false,
      "owner": {
        "login": "HeartSaVioR",
        "id": 1317309,
        "node_id": "MDQ6VXNlcjEzMTczMDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HeartSaVioR",
        "html_url": "https://github.com/HeartSaVioR",
        "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
        "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
        "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
        "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
        "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
        "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
        "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/HeartSaVioR/spark",
      "description": "Mirror of Apache Spark",
      "fork": true,
      "url": "https://api.github.com/repos/HeartSaVioR/spark",
      "forks_url": "https://api.github.com/repos/HeartSaVioR/spark/forks",
      "keys_url": "https://api.github.com/repos/HeartSaVioR/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/HeartSaVioR/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/HeartSaVioR/spark/teams",
      "hooks_url": "https://api.github.com/repos/HeartSaVioR/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/HeartSaVioR/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/HeartSaVioR/spark/events",
      "assignees_url": "https://api.github.com/repos/HeartSaVioR/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/HeartSaVioR/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/HeartSaVioR/spark/tags",
      "blobs_url": "https://api.github.com/repos/HeartSaVioR/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/HeartSaVioR/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/HeartSaVioR/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/HeartSaVioR/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/HeartSaVioR/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/HeartSaVioR/spark/languages",
      "stargazers_url": "https://api.github.com/repos/HeartSaVioR/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/HeartSaVioR/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/HeartSaVioR/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/HeartSaVioR/spark/subscription",
      "commits_url": "https://api.github.com/repos/HeartSaVioR/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/HeartSaVioR/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/HeartSaVioR/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/HeartSaVioR/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/HeartSaVioR/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/HeartSaVioR/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/HeartSaVioR/spark/merges",
      "archive_url": "https://api.github.com/repos/HeartSaVioR/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/HeartSaVioR/spark/downloads",
      "issues_url": "https://api.github.com/repos/HeartSaVioR/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/HeartSaVioR/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/HeartSaVioR/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/HeartSaVioR/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/HeartSaVioR/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/HeartSaVioR/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/HeartSaVioR/spark/deployments",
      "created_at": "2014-12-14T12:56:04Z",
      "updated_at": "2022-12-16T04:50:22Z",
      "pushed_at": "2022-12-20T14:06:19Z",
      "git_url": "git://github.com/HeartSaVioR/spark.git",
      "ssh_url": "git@github.com:HeartSaVioR/spark.git",
      "clone_url": "https://github.com/HeartSaVioR/spark.git",
      "svn_url": "https://github.com/HeartSaVioR/spark",
      "homepage": null,
      "size": 419410,
      "stargazers_count": 2,
      "watchers_count": 2,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 2,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 2,
      "watchers": 2,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "28ea445c4325ff567a1b80903e656cf34767e0fe",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 17165658,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNzE2NTY1OA==",
      "name": "spark",
      "full_name": "apache/spark",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/spark",
      "description": "Apache Spark - A unified analytics engine for large-scale data processing",
      "fork": false,
      "url": "https://api.github.com/repos/apache/spark",
      "forks_url": "https://api.github.com/repos/apache/spark/forks",
      "keys_url": "https://api.github.com/repos/apache/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/spark/teams",
      "hooks_url": "https://api.github.com/repos/apache/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/spark/events",
      "assignees_url": "https://api.github.com/repos/apache/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/spark/tags",
      "blobs_url": "https://api.github.com/repos/apache/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/spark/languages",
      "stargazers_url": "https://api.github.com/repos/apache/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/spark/subscription",
      "commits_url": "https://api.github.com/repos/apache/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/spark/merges",
      "archive_url": "https://api.github.com/repos/apache/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/spark/downloads",
      "issues_url": "https://api.github.com/repos/apache/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/spark/deployments",
      "created_at": "2014-02-25T08:00:08Z",
      "updated_at": "2022-12-27T00:03:36Z",
      "pushed_at": "2022-12-26T23:10:31Z",
      "git_url": "git://github.com/apache/spark.git",
      "ssh_url": "git@github.com:apache/spark.git",
      "clone_url": "https://github.com/apache/spark.git",
      "svn_url": "https://github.com/apache/spark",
      "homepage": "https://spark.apache.org/",
      "size": 451536,
      "stargazers_count": 34618,
      "watchers_count": 34618,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 26430,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 208,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "java",
        "jdbc",
        "python",
        "r",
        "scala",
        "spark",
        "sql"
      ],
      "visibility": "public",
      "forks": 26430,
      "open_issues": 208,
      "watchers": 34618,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/spark/pulls/25048"
    },
    "html": {
      "href": "https://github.com/apache/spark/pull/25048"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/spark/issues/25048"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/spark/issues/25048/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/spark/pulls/25048/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/spark/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/spark/pulls/25048/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/spark/statuses/6706a65ac2f7d7735332e7863c565e1994f5d431"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 42,
  "review_comments": 32,
  "maintainer_can_modify": false,
  "commits": 9,
  "additions": 47,
  "deletions": 16,
  "changed_files": 1
}