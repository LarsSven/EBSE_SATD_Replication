{
  "url": "https://api.github.com/repos/apache/spark/pulls/26108",
  "id": 327674142,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MzI3Njc0MTQy",
  "html_url": "https://github.com/apache/spark/pull/26108",
  "diff_url": "https://github.com/apache/spark/pull/26108.diff",
  "patch_url": "https://github.com/apache/spark/pull/26108.patch",
  "issue_url": "https://api.github.com/repos/apache/spark/issues/26108",
  "number": 26108,
  "state": "closed",
  "locked": false,
  "title": "[SPARK-26154][SS] Streaming left/right outer join should not return outer nulls for already matched rows",
  "user": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nThis patch fixes the edge case of streaming left/right outer join described below:\r\n\r\nSuppose query is provided as\r\n\r\n`select * from A join B on A.id = B.id AND (A.ts <= B.ts AND B.ts <= A.ts + interval 5 seconds)`\r\n\r\nand there're two rows for L1 (from A) and R1 (from B) which ensures L1.id = R1.id and L1.ts = R1.ts.\r\n(we can simply imagine it from self-join)\r\n\r\nThen Spark processes L1 and R1 as below:\r\n\r\n- row L1 and row R1 are joined at batch 1\r\n- row R1 is evicted at batch 2 due to join and watermark condition, whereas row L1 is not evicted\r\n- row L1 is evicted at batch 3 due to join and watermark condition\r\n\r\nWhen determining outer rows to match with null, Spark applies some assumption commented in codebase, as below:\r\n\r\n```\r\nChecking whether the current row matches a key in the right side state, and that key\t\r\nhas any value which satisfies the filter function when joined. If it doesn't,\t\r\nwe know we can join with null, since there was never (including this batch) a match\t\r\nwithin the watermark period. If it does, there must have been a match at some point, so\t\r\nwe know we can't join with null.\r\n```\r\n\r\nBut as explained the edge-case earlier, the assumption is not correct. As we don't have any good assumption to optimize which doesn't have edge-case, we have to track whether such row is matched with others before, and match with null row only when the row is not matched.\r\n\r\nTo track the matching of row, the patch adds a new state to streaming join state manager, and mark whether the row is matched to others or not. We leverage the information when dealing with eviction of rows which would be candidates to match with null rows.\r\n\r\nThis approach introduces new state format which is not compatible with old state format - queries with old state format will be still running but they will still have the issue and be required to discard checkpoint and rerun to take this patch in effect.\r\n\r\n### Why are the changes needed?\r\n\r\nThis patch fixes a correctness issue.\r\n\r\n### Does this PR introduce any user-facing change?\r\n\r\nNo for compatibility viewpoint, but we'll encourage end users to discard the old checkpoint and rerun the query if they run stream-stream outer join query with old checkpoint, which might be \"yes\" for the question.\r\n\r\n### How was this patch tested?\r\n\r\nAdded UT which fails on current Spark and passes with this patch. Also passed existing streaming join UTs.",
  "created_at": "2019-10-14T07:26:01Z",
  "updated_at": "2020-04-08T06:41:19Z",
  "closed_at": "2019-11-11T23:47:35Z",
  "merged_at": null,
  "merge_commit_sha": "d1206191d4b84038cb42d617fcf6865b58e619d1",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/spark/pulls/26108/commits",
  "review_comments_url": "https://api.github.com/repos/apache/spark/pulls/26108/comments",
  "review_comment_url": "https://api.github.com/repos/apache/spark/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/26108/comments",
  "statuses_url": "https://api.github.com/repos/apache/spark/statuses/7213d4266b7bfa2bd05225c68e2184a7abb24469",
  "head": {
    "label": "HeartSaVioR:SPARK-26154-shorten-alternative",
    "ref": "SPARK-26154-shorten-alternative",
    "sha": "7213d4266b7bfa2bd05225c68e2184a7abb24469",
    "user": {
      "login": "HeartSaVioR",
      "id": 1317309,
      "node_id": "MDQ6VXNlcjEzMTczMDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/HeartSaVioR",
      "html_url": "https://github.com/HeartSaVioR",
      "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
      "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
      "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
      "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
      "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
      "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
      "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 27994296,
      "node_id": "MDEwOlJlcG9zaXRvcnkyNzk5NDI5Ng==",
      "name": "spark",
      "full_name": "HeartSaVioR/spark",
      "private": false,
      "owner": {
        "login": "HeartSaVioR",
        "id": 1317309,
        "node_id": "MDQ6VXNlcjEzMTczMDk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HeartSaVioR",
        "html_url": "https://github.com/HeartSaVioR",
        "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
        "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
        "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
        "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
        "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
        "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
        "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/HeartSaVioR/spark",
      "description": "Mirror of Apache Spark",
      "fork": true,
      "url": "https://api.github.com/repos/HeartSaVioR/spark",
      "forks_url": "https://api.github.com/repos/HeartSaVioR/spark/forks",
      "keys_url": "https://api.github.com/repos/HeartSaVioR/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/HeartSaVioR/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/HeartSaVioR/spark/teams",
      "hooks_url": "https://api.github.com/repos/HeartSaVioR/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/HeartSaVioR/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/HeartSaVioR/spark/events",
      "assignees_url": "https://api.github.com/repos/HeartSaVioR/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/HeartSaVioR/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/HeartSaVioR/spark/tags",
      "blobs_url": "https://api.github.com/repos/HeartSaVioR/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/HeartSaVioR/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/HeartSaVioR/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/HeartSaVioR/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/HeartSaVioR/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/HeartSaVioR/spark/languages",
      "stargazers_url": "https://api.github.com/repos/HeartSaVioR/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/HeartSaVioR/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/HeartSaVioR/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/HeartSaVioR/spark/subscription",
      "commits_url": "https://api.github.com/repos/HeartSaVioR/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/HeartSaVioR/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/HeartSaVioR/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/HeartSaVioR/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/HeartSaVioR/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/HeartSaVioR/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/HeartSaVioR/spark/merges",
      "archive_url": "https://api.github.com/repos/HeartSaVioR/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/HeartSaVioR/spark/downloads",
      "issues_url": "https://api.github.com/repos/HeartSaVioR/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/HeartSaVioR/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/HeartSaVioR/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/HeartSaVioR/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/HeartSaVioR/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/HeartSaVioR/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/HeartSaVioR/spark/deployments",
      "created_at": "2014-12-14T12:56:04Z",
      "updated_at": "2022-12-16T04:50:22Z",
      "pushed_at": "2022-12-20T14:06:19Z",
      "git_url": "git://github.com/HeartSaVioR/spark.git",
      "ssh_url": "git@github.com:HeartSaVioR/spark.git",
      "clone_url": "https://github.com/HeartSaVioR/spark.git",
      "svn_url": "https://github.com/HeartSaVioR/spark",
      "homepage": null,
      "size": 419410,
      "stargazers_count": 2,
      "watchers_count": 2,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 2,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 2,
      "watchers": 2,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "67e1360bade9ef7691746f63ca99411cfe9d249b",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 17165658,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNzE2NTY1OA==",
      "name": "spark",
      "full_name": "apache/spark",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/spark",
      "description": "Apache Spark - A unified analytics engine for large-scale data processing",
      "fork": false,
      "url": "https://api.github.com/repos/apache/spark",
      "forks_url": "https://api.github.com/repos/apache/spark/forks",
      "keys_url": "https://api.github.com/repos/apache/spark/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/spark/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/spark/teams",
      "hooks_url": "https://api.github.com/repos/apache/spark/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/spark/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/spark/events",
      "assignees_url": "https://api.github.com/repos/apache/spark/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/spark/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/spark/tags",
      "blobs_url": "https://api.github.com/repos/apache/spark/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/spark/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/spark/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/spark/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/spark/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/spark/languages",
      "stargazers_url": "https://api.github.com/repos/apache/spark/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/spark/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/spark/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/spark/subscription",
      "commits_url": "https://api.github.com/repos/apache/spark/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/spark/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/spark/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/spark/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/spark/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/spark/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/spark/merges",
      "archive_url": "https://api.github.com/repos/apache/spark/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/spark/downloads",
      "issues_url": "https://api.github.com/repos/apache/spark/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/spark/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/spark/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/spark/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/spark/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/spark/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/spark/deployments",
      "created_at": "2014-02-25T08:00:08Z",
      "updated_at": "2022-12-26T21:18:49Z",
      "pushed_at": "2022-12-26T23:10:31Z",
      "git_url": "git://github.com/apache/spark.git",
      "ssh_url": "git@github.com:apache/spark.git",
      "clone_url": "https://github.com/apache/spark.git",
      "svn_url": "https://github.com/apache/spark",
      "homepage": "https://spark.apache.org/",
      "size": 451536,
      "stargazers_count": 34617,
      "watchers_count": 34617,
      "language": "Scala",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 26430,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 208,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "java",
        "jdbc",
        "python",
        "r",
        "scala",
        "spark",
        "sql"
      ],
      "visibility": "public",
      "forks": 26430,
      "open_issues": 208,
      "watchers": 34617,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/spark/pulls/26108"
    },
    "html": {
      "href": "https://github.com/apache/spark/pull/26108"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/spark/issues/26108"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/spark/issues/26108/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/spark/pulls/26108/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/spark/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/spark/pulls/26108/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/spark/statuses/7213d4266b7bfa2bd05225c68e2184a7abb24469"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 25,
  "review_comments": 49,
  "maintainer_can_modify": false,
  "commits": 8,
  "additions": 528,
  "deletions": 82,
  "changed_files": 31
}