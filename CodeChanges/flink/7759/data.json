{
  "url": "https://api.github.com/repos/apache/flink/pulls/7759",
  "id": 254513759,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjU0NTEzNzU5",
  "html_url": "https://github.com/apache/flink/pull/7759",
  "diff_url": "https://github.com/apache/flink/pull/7759.diff",
  "patch_url": "https://github.com/apache/flink/pull/7759.patch",
  "issue_url": "https://api.github.com/repos/apache/flink/issues/7759",
  "number": 7759,
  "state": "closed",
  "locked": false,
  "title": "[FLINK-11485][FLINK-10897] POJO state schema evolution / migrate PojoSerializer to use new compatibility APIs",
  "user": {
    "login": "tzulitai",
    "id": 5284370,
    "node_id": "MDQ6VXNlcjUyODQzNzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5284370?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tzulitai",
    "html_url": "https://github.com/tzulitai",
    "followers_url": "https://api.github.com/users/tzulitai/followers",
    "following_url": "https://api.github.com/users/tzulitai/following{/other_user}",
    "gists_url": "https://api.github.com/users/tzulitai/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tzulitai/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tzulitai/subscriptions",
    "organizations_url": "https://api.github.com/users/tzulitai/orgs",
    "repos_url": "https://api.github.com/users/tzulitai/repos",
    "events_url": "https://api.github.com/users/tzulitai/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tzulitai/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "## What is the purpose of the change\r\n\r\nThis PR mainly solves FLINK-11485 (migrate `PojoSerializer` to use new serialization compatibility APIs), while also solving FLINK-10897 (support POJO state schema evolution) indirectly.\r\n\r\nThe new snapshot class for the `PojoSerializer` is now the `PojoSerializerSnapshot`.\r\nThis new snapshot class has the following features:\r\n- Avoids Java serialization completely, including serialization of POJO fields and POJO type class. This allows us to restore the snapshot properly when fields are removed or added to the POJO type class.\r\n- Properly supports schema evolution of POJO types, by properly signaling `compatibleAfterMigration` when fields are added or removed from the target POJO type. When performing migration, the old POJO serializer obtained from `PojoSerializerSnapshot#restoreSerializer`, which is used to read old data into Java objects before writing them again with the new POJO serializer, is capable of reading and dropping values of fields that no longer exist.\r\n- Properly reconfigures the `PojoSerializer` by providing a new reconfigured instance via `compatibleWithReconfiguredSerializer`. This allows the implementation of the `PojoSerializer` to be immutable.\r\n\r\nPlease see below for the detailed list of changes.\r\n\r\n## Brief change log\r\n\r\n- 3bd3f73 to 843088c: Cherry-picking / refactoring of the `OptionalMap` utility introduced by @igalshilman in #7496. This is refactored because it will be useful for the `PojoSerializerSnapshot` as well.\r\n\r\n- 1ebaf91: Refactor the logic of resolving overall compatibility results across multiple nested serializers of a composite serializer out of the `CompositeTypeSerializerSnapshot` class. The `PojoSerializer` also has nested serializers (e.g. field serializer, registered subclass serializers), and will make use of this common utility.\r\n\r\n- a84c54a: Introduces a new `PojoSerializerSnapshotData` class. This is a container class for the actual snapshotted content of a `PojoSerializer`. The important bits here is reading / writing of the snapshot content, as well as how missing fields / classes in the snapshot content at restore time is handled. Please see the class for the serialization format and content of the snapshotted data.\r\n\r\n- e77e828: Introduces a new `PojoSerializerSnapshot` class, to be the new snapshot class for the `PojoSerializer`. The read / write of the snapshot is delegated to the `PojoSerializerSnapshotData`, so the important part here is the compatibility resolution logic in `resolveSchemaCompatibility`, as well as creation of the restore serializer in `restoreSerializer` method. The restored serializer should be able to handle missing fields in the new Pojo type; values of missing fields will be read and simply dropped.\r\n\r\n- 44bfc4b: This is the main change that lets the `PojoSerializer` use the new snapshot class, and no longer uses the now deprecated `PojoSerializerConfigSnapshot`. This also deals with how the `PojoSerializerConfigSnapshot` delegates compatibility checks to the new snapshot class, when restoring from savepoint version earlier than 1.8.0. Since the new snapshot class properly handles POJO schema changes, this commit essentially also enables POJO state schema evolution.\r\n\r\n- 0941b45: Touches `PojoSerializerTest` and `PojoSerializerUpgradeTest`. Changes in the `PojoSerializerTest` confirms that the new `PojoSerializer` actually handles reconfiguration cases properly. Changes in the `PojoSerializerUpgradeTest` is mostly removing the behaviour of expecting errors when the schema of a POJO type is changed. Removing those test behaviours confirms that POJO schema can indeed be evolved now.\r\n\r\n- 49d9bce: Documents POJO schema evolution in the \"Working with State\" docs.\r\n\r\n## Verifying this change\r\n\r\n- Changes to `PojoSerializerTest` confirms that the new `PojoSerializer` handles compatibility resolution properly.\r\n- Changes to `PojoSerializerUpgradeTest` confirms that POJO fields can be removed / added when restoring from savepoints.\r\n- A new `PojoSerializerSnapshotMigrationTest` confirms that old savepoints with the legacy `PojoSerializerConfigSnapshot` can be smoothly migrated to the new `PojoSerializerSnapshot` in 1.8.0.\r\n\r\n## Does this pull request potentially affect one of the following parts:\r\n\r\n  - Dependencies (does it add or upgrade a dependency):  **no**\r\n  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: **no**\r\n  - The serializers: **yes**\r\n  - The runtime per-record code paths (performance sensitive): **no**\r\n  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: **yes**\r\n  - The S3 file system connector: **no**\r\n\r\n## Documentation\r\n\r\n  - Does this pull request introduce a new feature? **yes - POJO state schema evolution**\r\n  - If yes, how is the feature documented? **docs**\r\n",
  "created_at": "2019-02-20T06:19:57Z",
  "updated_at": "2019-03-18T20:08:11Z",
  "closed_at": "2019-02-22T07:46:58Z",
  "merged_at": null,
  "merge_commit_sha": "9405dbb4ee885c9f1b86e290d15d69055a7d8b4e",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 1273183016,
      "node_id": "MDU6TGFiZWwxMjczMTgzMDE2",
      "url": "https://api.github.com/repos/apache/flink/labels/component=API/TypeSerializationSystem",
      "name": "component=API/TypeSerializationSystem",
      "color": "175fb7",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/flink/pulls/7759/commits",
  "review_comments_url": "https://api.github.com/repos/apache/flink/pulls/7759/comments",
  "review_comment_url": "https://api.github.com/repos/apache/flink/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/flink/issues/7759/comments",
  "statuses_url": "https://api.github.com/repos/apache/flink/statuses/fd8fd0325a11002af5dd87d45eddb95e6ce7ffa7",
  "head": {
    "label": "tzulitai:FLINK-11485",
    "ref": "FLINK-11485",
    "sha": "fd8fd0325a11002af5dd87d45eddb95e6ce7ffa7",
    "user": {
      "login": "tzulitai",
      "id": 5284370,
      "node_id": "MDQ6VXNlcjUyODQzNzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5284370?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tzulitai",
      "html_url": "https://github.com/tzulitai",
      "followers_url": "https://api.github.com/users/tzulitai/followers",
      "following_url": "https://api.github.com/users/tzulitai/following{/other_user}",
      "gists_url": "https://api.github.com/users/tzulitai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tzulitai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tzulitai/subscriptions",
      "organizations_url": "https://api.github.com/users/tzulitai/orgs",
      "repos_url": "https://api.github.com/users/tzulitai/repos",
      "events_url": "https://api.github.com/users/tzulitai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tzulitai/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 55886834,
      "node_id": "MDEwOlJlcG9zaXRvcnk1NTg4NjgzNA==",
      "name": "flink",
      "full_name": "tzulitai/flink",
      "private": false,
      "owner": {
        "login": "tzulitai",
        "id": 5284370,
        "node_id": "MDQ6VXNlcjUyODQzNzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5284370?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tzulitai",
        "html_url": "https://github.com/tzulitai",
        "followers_url": "https://api.github.com/users/tzulitai/followers",
        "following_url": "https://api.github.com/users/tzulitai/following{/other_user}",
        "gists_url": "https://api.github.com/users/tzulitai/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tzulitai/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tzulitai/subscriptions",
        "organizations_url": "https://api.github.com/users/tzulitai/orgs",
        "repos_url": "https://api.github.com/users/tzulitai/repos",
        "events_url": "https://api.github.com/users/tzulitai/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tzulitai/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/tzulitai/flink",
      "description": "Mirror of Apache Flink",
      "fork": true,
      "url": "https://api.github.com/repos/tzulitai/flink",
      "forks_url": "https://api.github.com/repos/tzulitai/flink/forks",
      "keys_url": "https://api.github.com/repos/tzulitai/flink/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/tzulitai/flink/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/tzulitai/flink/teams",
      "hooks_url": "https://api.github.com/repos/tzulitai/flink/hooks",
      "issue_events_url": "https://api.github.com/repos/tzulitai/flink/issues/events{/number}",
      "events_url": "https://api.github.com/repos/tzulitai/flink/events",
      "assignees_url": "https://api.github.com/repos/tzulitai/flink/assignees{/user}",
      "branches_url": "https://api.github.com/repos/tzulitai/flink/branches{/branch}",
      "tags_url": "https://api.github.com/repos/tzulitai/flink/tags",
      "blobs_url": "https://api.github.com/repos/tzulitai/flink/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/tzulitai/flink/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/tzulitai/flink/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/tzulitai/flink/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/tzulitai/flink/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/tzulitai/flink/languages",
      "stargazers_url": "https://api.github.com/repos/tzulitai/flink/stargazers",
      "contributors_url": "https://api.github.com/repos/tzulitai/flink/contributors",
      "subscribers_url": "https://api.github.com/repos/tzulitai/flink/subscribers",
      "subscription_url": "https://api.github.com/repos/tzulitai/flink/subscription",
      "commits_url": "https://api.github.com/repos/tzulitai/flink/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/tzulitai/flink/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/tzulitai/flink/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/tzulitai/flink/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/tzulitai/flink/contents/{+path}",
      "compare_url": "https://api.github.com/repos/tzulitai/flink/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/tzulitai/flink/merges",
      "archive_url": "https://api.github.com/repos/tzulitai/flink/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/tzulitai/flink/downloads",
      "issues_url": "https://api.github.com/repos/tzulitai/flink/issues{/number}",
      "pulls_url": "https://api.github.com/repos/tzulitai/flink/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/tzulitai/flink/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/tzulitai/flink/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/tzulitai/flink/labels{/name}",
      "releases_url": "https://api.github.com/repos/tzulitai/flink/releases{/id}",
      "deployments_url": "https://api.github.com/repos/tzulitai/flink/deployments",
      "created_at": "2016-04-10T07:41:34Z",
      "updated_at": "2020-08-20T08:48:57Z",
      "pushed_at": "2021-01-15T06:18:33Z",
      "git_url": "git://github.com/tzulitai/flink.git",
      "ssh_url": "git@github.com:tzulitai/flink.git",
      "clone_url": "https://github.com/tzulitai/flink.git",
      "svn_url": "https://github.com/tzulitai/flink",
      "homepage": null,
      "size": 266738,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "Java",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 1,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 0,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 1,
      "open_issues": 0,
      "watchers": 0,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "397c9c60e9d24556945d9c59507bfb0dbd6e31a6",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 20587599,
      "node_id": "MDEwOlJlcG9zaXRvcnkyMDU4NzU5OQ==",
      "name": "flink",
      "full_name": "apache/flink",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/flink",
      "description": "Apache Flink",
      "fork": false,
      "url": "https://api.github.com/repos/apache/flink",
      "forks_url": "https://api.github.com/repos/apache/flink/forks",
      "keys_url": "https://api.github.com/repos/apache/flink/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/flink/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/flink/teams",
      "hooks_url": "https://api.github.com/repos/apache/flink/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/flink/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/flink/events",
      "assignees_url": "https://api.github.com/repos/apache/flink/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/flink/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/flink/tags",
      "blobs_url": "https://api.github.com/repos/apache/flink/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/flink/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/flink/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/flink/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/flink/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/flink/languages",
      "stargazers_url": "https://api.github.com/repos/apache/flink/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/flink/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/flink/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/flink/subscription",
      "commits_url": "https://api.github.com/repos/apache/flink/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/flink/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/flink/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/flink/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/flink/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/flink/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/flink/merges",
      "archive_url": "https://api.github.com/repos/apache/flink/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/flink/downloads",
      "issues_url": "https://api.github.com/repos/apache/flink/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/flink/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/flink/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/flink/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/flink/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/flink/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/flink/deployments",
      "created_at": "2014-06-07T07:00:10Z",
      "updated_at": "2022-12-26T19:40:03Z",
      "pushed_at": "2022-12-26T22:52:46Z",
      "git_url": "git://github.com/apache/flink.git",
      "ssh_url": "git@github.com:apache/flink.git",
      "clone_url": "https://github.com/apache/flink.git",
      "svn_url": "https://github.com/apache/flink",
      "homepage": "",
      "size": 482713,
      "stargazers_count": 20359,
      "watchers_count": 20359,
      "language": "Java",
      "has_issues": false,
      "has_projects": false,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 11535,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 953,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "flink",
        "java",
        "python",
        "scala",
        "sql"
      ],
      "visibility": "public",
      "forks": 11535,
      "open_issues": 953,
      "watchers": 20359,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/flink/pulls/7759"
    },
    "html": {
      "href": "https://github.com/apache/flink/pull/7759"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/flink/issues/7759"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/flink/issues/7759/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/flink/pulls/7759/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/flink/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/flink/pulls/7759/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/flink/statuses/fd8fd0325a11002af5dd87d45eddb95e6ce7ffa7"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 6,
  "review_comments": 31,
  "maintainer_can_modify": false,
  "commits": 18,
  "additions": 2678,
  "deletions": 481,
  "changed_files": 20
}