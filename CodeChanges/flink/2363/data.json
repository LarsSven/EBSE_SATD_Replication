{
  "url": "https://api.github.com/repos/apache/flink/pulls/2363",
  "id": 81112889,
  "node_id": "MDExOlB1bGxSZXF1ZXN0ODExMTI4ODk=",
  "html_url": "https://github.com/apache/flink/pull/2363",
  "diff_url": "https://github.com/apache/flink/pull/2363.diff",
  "patch_url": "https://github.com/apache/flink/pull/2363.patch",
  "issue_url": "https://api.github.com/repos/apache/flink/issues/2363",
  "number": 2363,
  "state": "closed",
  "locked": false,
  "title": "[FLINK-4389] Expose metrics to WebFrontend",
  "user": {
    "login": "zentol",
    "id": 5725237,
    "node_id": "MDQ6VXNlcjU3MjUyMzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5725237?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zentol",
    "html_url": "https://github.com/zentol",
    "followers_url": "https://api.github.com/users/zentol/followers",
    "following_url": "https://api.github.com/users/zentol/following{/other_user}",
    "gists_url": "https://api.github.com/users/zentol/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zentol/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zentol/subscriptions",
    "organizations_url": "https://api.github.com/users/zentol/orgs",
    "repos_url": "https://api.github.com/users/zentol/repos",
    "events_url": "https://api.github.com/users/zentol/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zentol/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "This PR exposes metrics to the Webfrontend, as proposed in [FLIP-7](https://cwiki.apache.org/confluence/display/FLINK/FLIP-7%3A+Expose+metrics+to+WebInterface).\n\nThis PR builds on-top of #2300, meaning that 2866f56 is not part of the PR.\n\nI've split the implementation into 5 commits that implement\n- the generation of a separate scope string for the WebInterface\n- the MetricQueryService, a separate actor running on all Job-/TaskManagers whose main purpose is to create and return a dump of the metrics when queried to do so\n- the MetricStore, a nested data structure used in the WebInterface to store transmitted metrics\n- the MetricFetcher, which is used by the WebInterface to fetch metrics from Job-/TaskManagers\n- various MetricsHandler classes, which handle REST calls requesting specific metrics\n### MetricQueryService\n\nThe MetricQueryService is an actor running inside the MetricRegistry acting like an unscheduled reporter that is queried from the outside for a report. The MetricRegistry notifies it of added/removed metrics whereas the MetricFetcher sends report requests to the JM/TM which are then forwarded to the MetricQueryService, which answers directly to the MetricFetcher.\n\nThe report is one big `Object[]`, which contains for each metric\n1. the type of the metric, encoded as a byte (so that we know how many values are transmitted)\n2. the fully qualified metric name (based on the separate format)\n3. the value(s) of the metric (turned into Strings for Gauges)\n### MetricStore\n\nThe MetricStore is a relatively simple nested data-structure that contains one HashMap<String, Object> for every JM/TM/job/task. Received metrics are added to these HashMaps based on the format string. There is only a single MetricStore instance in the WebInterface.\n### MetricFetcher\n\nThe MetricFetcher initiates the transfer and cleanup of metrics. It contains the MetricStore instance, which is accessed by MetricHandlers. The fetching is only done when a handler asks for it, with a minimum duration of 10 seconds between updates. As such no fetching will be done if the metrics are not accessed with REST calls.\n\nThe fetching procedure can be summed up in pseudo-code as following:\n\n```\nfetch():\n    askJobManagerForJobDetails()\n        => retain all metrics belonging to the given jobs\n    askJobManagerForMetrics()\n        => add received metrics to MetricStore\n    askJobManagerForRegisteredTaskManagers()\n        => retain all metrics belonging to registered task managers\n        => for each TaskManager:\n            askTaskManagerForMetrics()\n                => add received metrics to MetricStore\n```\n### MetricsHandler\n\nThe MetricsHandlers deal with two requests:\n- getAllAvailableMetrics - any REST request that does not have a `get` query parameter is treated as a request for all available metrics for a given JM/TM/job/task, denoted by the REST path. The reply will be a JSON array, for example: `[{\"id\":\"metric_1\"},{\"id\":\"metric_2\"}]`\n- getMetricValues - the Webfrontend can request the values for several metrics by passing a comma-separated list of metric id's as the `get` query parameter. The reply will be a JSON array of id:value pairs, for example: `[{\"id\":\"metric_1\", \"value\":\"4\"}]` or an empty string if an error occurred.\n",
  "created_at": "2016-08-12T12:43:20Z",
  "updated_at": "2019-03-14T18:39:10Z",
  "closed_at": "2016-09-15T17:19:49Z",
  "merged_at": null,
  "merge_commit_sha": "e3a21cec4412d74e5197521cf2796794f756474e",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 1273025479,
      "node_id": "MDU6TGFiZWwxMjczMDI1NDc5",
      "url": "https://api.github.com/repos/apache/flink/labels/component=Runtime/WebFrontend",
      "name": "component=Runtime/WebFrontend",
      "color": "175fb7",
      "default": false,
      "description": null
    },
    {
      "id": 1273342730,
      "node_id": "MDU6TGFiZWwxMjczMzQyNzMw",
      "url": "https://api.github.com/repos/apache/flink/labels/component=Runtime/Metrics",
      "name": "component=Runtime/Metrics",
      "color": "175fb7",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/flink/pulls/2363/commits",
  "review_comments_url": "https://api.github.com/repos/apache/flink/pulls/2363/comments",
  "review_comment_url": "https://api.github.com/repos/apache/flink/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/flink/issues/2363/comments",
  "statuses_url": "https://api.github.com/repos/apache/flink/statuses/a91831df9265f49d43dac7b597a9f818587c3a2f",
  "head": {
    "label": "zentol:4389_metrics_exposed",
    "ref": "4389_metrics_exposed",
    "sha": "a91831df9265f49d43dac7b597a9f818587c3a2f",
    "user": {
      "login": "zentol",
      "id": 5725237,
      "node_id": "MDQ6VXNlcjU3MjUyMzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5725237?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zentol",
      "html_url": "https://github.com/zentol",
      "followers_url": "https://api.github.com/users/zentol/followers",
      "following_url": "https://api.github.com/users/zentol/following{/other_user}",
      "gists_url": "https://api.github.com/users/zentol/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zentol/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zentol/subscriptions",
      "organizations_url": "https://api.github.com/users/zentol/orgs",
      "repos_url": "https://api.github.com/users/zentol/repos",
      "events_url": "https://api.github.com/users/zentol/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zentol/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 20647396,
      "node_id": "MDEwOlJlcG9zaXRvcnkyMDY0NzM5Ng==",
      "name": "flink",
      "full_name": "zentol/flink",
      "private": false,
      "owner": {
        "login": "zentol",
        "id": 5725237,
        "node_id": "MDQ6VXNlcjU3MjUyMzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5725237?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zentol",
        "html_url": "https://github.com/zentol",
        "followers_url": "https://api.github.com/users/zentol/followers",
        "following_url": "https://api.github.com/users/zentol/following{/other_user}",
        "gists_url": "https://api.github.com/users/zentol/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/zentol/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zentol/subscriptions",
        "organizations_url": "https://api.github.com/users/zentol/orgs",
        "repos_url": "https://api.github.com/users/zentol/repos",
        "events_url": "https://api.github.com/users/zentol/events{/privacy}",
        "received_events_url": "https://api.github.com/users/zentol/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/zentol/flink",
      "description": "Mirror of Apache Flink",
      "fork": true,
      "url": "https://api.github.com/repos/zentol/flink",
      "forks_url": "https://api.github.com/repos/zentol/flink/forks",
      "keys_url": "https://api.github.com/repos/zentol/flink/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/zentol/flink/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/zentol/flink/teams",
      "hooks_url": "https://api.github.com/repos/zentol/flink/hooks",
      "issue_events_url": "https://api.github.com/repos/zentol/flink/issues/events{/number}",
      "events_url": "https://api.github.com/repos/zentol/flink/events",
      "assignees_url": "https://api.github.com/repos/zentol/flink/assignees{/user}",
      "branches_url": "https://api.github.com/repos/zentol/flink/branches{/branch}",
      "tags_url": "https://api.github.com/repos/zentol/flink/tags",
      "blobs_url": "https://api.github.com/repos/zentol/flink/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/zentol/flink/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/zentol/flink/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/zentol/flink/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/zentol/flink/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/zentol/flink/languages",
      "stargazers_url": "https://api.github.com/repos/zentol/flink/stargazers",
      "contributors_url": "https://api.github.com/repos/zentol/flink/contributors",
      "subscribers_url": "https://api.github.com/repos/zentol/flink/subscribers",
      "subscription_url": "https://api.github.com/repos/zentol/flink/subscription",
      "commits_url": "https://api.github.com/repos/zentol/flink/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/zentol/flink/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/zentol/flink/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/zentol/flink/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/zentol/flink/contents/{+path}",
      "compare_url": "https://api.github.com/repos/zentol/flink/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/zentol/flink/merges",
      "archive_url": "https://api.github.com/repos/zentol/flink/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/zentol/flink/downloads",
      "issues_url": "https://api.github.com/repos/zentol/flink/issues{/number}",
      "pulls_url": "https://api.github.com/repos/zentol/flink/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/zentol/flink/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/zentol/flink/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/zentol/flink/labels{/name}",
      "releases_url": "https://api.github.com/repos/zentol/flink/releases{/id}",
      "deployments_url": "https://api.github.com/repos/zentol/flink/deployments",
      "created_at": "2014-06-09T13:27:33Z",
      "updated_at": "2021-10-07T11:10:02Z",
      "pushed_at": "2022-12-14T16:30:41Z",
      "git_url": "git://github.com/zentol/flink.git",
      "ssh_url": "git@github.com:zentol/flink.git",
      "clone_url": "https://github.com/zentol/flink.git",
      "svn_url": "https://github.com/zentol/flink",
      "homepage": null,
      "size": 416630,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "Java",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 1,
      "watchers": 0,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "9420a775f4689ec57c9026b418c5961c33263265",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 20587599,
      "node_id": "MDEwOlJlcG9zaXRvcnkyMDU4NzU5OQ==",
      "name": "flink",
      "full_name": "apache/flink",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/flink",
      "description": "Apache Flink",
      "fork": false,
      "url": "https://api.github.com/repos/apache/flink",
      "forks_url": "https://api.github.com/repos/apache/flink/forks",
      "keys_url": "https://api.github.com/repos/apache/flink/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/flink/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/flink/teams",
      "hooks_url": "https://api.github.com/repos/apache/flink/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/flink/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/flink/events",
      "assignees_url": "https://api.github.com/repos/apache/flink/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/flink/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/flink/tags",
      "blobs_url": "https://api.github.com/repos/apache/flink/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/flink/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/flink/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/flink/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/flink/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/flink/languages",
      "stargazers_url": "https://api.github.com/repos/apache/flink/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/flink/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/flink/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/flink/subscription",
      "commits_url": "https://api.github.com/repos/apache/flink/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/flink/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/flink/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/flink/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/flink/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/flink/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/flink/merges",
      "archive_url": "https://api.github.com/repos/apache/flink/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/flink/downloads",
      "issues_url": "https://api.github.com/repos/apache/flink/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/flink/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/flink/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/flink/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/flink/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/flink/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/flink/deployments",
      "created_at": "2014-06-07T07:00:10Z",
      "updated_at": "2022-12-26T19:40:03Z",
      "pushed_at": "2022-12-26T22:52:46Z",
      "git_url": "git://github.com/apache/flink.git",
      "ssh_url": "git@github.com:apache/flink.git",
      "clone_url": "https://github.com/apache/flink.git",
      "svn_url": "https://github.com/apache/flink",
      "homepage": "",
      "size": 482713,
      "stargazers_count": 20359,
      "watchers_count": 20359,
      "language": "Java",
      "has_issues": false,
      "has_projects": false,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 11535,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 953,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "big-data",
        "flink",
        "java",
        "python",
        "scala",
        "sql"
      ],
      "visibility": "public",
      "forks": 11535,
      "open_issues": 953,
      "watchers": 20359,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/flink/pulls/2363"
    },
    "html": {
      "href": "https://github.com/apache/flink/pull/2363"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/flink/issues/2363"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/flink/issues/2363/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/flink/pulls/2363/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/flink/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/flink/pulls/2363/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/flink/statuses/a91831df9265f49d43dac7b597a9f818587c3a2f"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": false,
  "rebaseable": false,
  "mergeable_state": "dirty",
  "merged_by": null,
  "comments": 14,
  "review_comments": 61,
  "maintainer_can_modify": false,
  "commits": 4,
  "additions": 3202,
  "deletions": 100,
  "changed_files": 53
}