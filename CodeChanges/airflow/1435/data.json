{
  "url": "https://api.github.com/repos/apache/airflow/pulls/1435",
  "id": 67972824,
  "node_id": "MDExOlB1bGxSZXF1ZXN0Njc5NzI4MjQ=",
  "html_url": "https://github.com/apache/airflow/pull/1435",
  "diff_url": "https://github.com/apache/airflow/pull/1435.diff",
  "patch_url": "https://github.com/apache/airflow/pull/1435.patch",
  "issue_url": "https://api.github.com/repos/apache/airflow/issues/1435",
  "number": 1435,
  "state": "closed",
  "locked": false,
  "title": "First draft of blocked task dependency explainer",
  "user": {
    "login": "aoen",
    "id": 1592778,
    "node_id": "MDQ6VXNlcjE1OTI3Nzg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1592778?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aoen",
    "html_url": "https://github.com/aoen",
    "followers_url": "https://api.github.com/users/aoen/followers",
    "following_url": "https://api.github.com/users/aoen/following{/other_user}",
    "gists_url": "https://api.github.com/users/aoen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aoen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aoen/subscriptions",
    "organizations_url": "https://api.github.com/users/aoen/orgs",
    "repos_url": "https://api.github.com/users/aoen/repos",
    "events_url": "https://api.github.com/users/aoen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aoen/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "**THIS IS A DRAFT WIP PULL REQUEST**\nThis is a draft for a solution to https://github.com/airbnb/airflow/issues/1383 among several other things.\nThere are tons of things broken/missing here, I'm just putting this out there to get some initial eyes on the high-level changes.\n\n**Goals**\n- Simplify, consolidate, and make consistent the logic of whether or not a task should be run\n- Provide a view that gives insight into why a task instance is not currently running (no more viewing the scheduler logs to find out why a task instance isn't running for the majority of cases)\n  e.g. (this will not be the final product):\n  ![image](https://cloud.githubusercontent.com/assets/1592778/14835487/daf435e4-0bbe-11e6-9650-844543bb82e7.png)\n\n**Things to review in this PR**\n- The high level idea of refactoring of all of the dependency checking for regular task execution, backfills, etc into one single function\n- Any of the functional changes (not the code itself) made listed in \"Some big changes made in this PR\"\n- The design of the BaseTIDep class\n- Any changes in design that would require a complete rewrite of the current changes (where it would be non-trivial to change the code in the PRs diff to conform with the new design)\n\n**Things NOT to review in this PR**\n- The view layer for surfacing the failing dependencies to users\n- Bugs/debugging statements that should be removed/lack of tests/lack of comments/etc.\n- Failing CI/merge conflicts, due to the somewhat large scope of this change I will iterate on a fixed SHA on master and then either rebase all at once or break the PR up into smaller parts and release them individually\n- Performance/DB hits (Max had some valid concerns and I will test for this and optimize/cache as appropriate)\n\n**Some big changes made in this PR**\n- Paused DAG checking now occurs at the task instance level in models.py instead of in jobs.py to consolidate the \"should this task run\" logic into one place\n- Pool behavior in backfills is now consistent with how regular tasks are pooled (pools are always respected in backfills).\n  This will break one use case:\n  Using pools to restrict some resource on airflow executors themselves (rather than an external resource like a DB), e.g. some task uses 60% of cpu on a worker so we restrict that task's pool size to 1 to prevent two of the tasks from running on the same host. When backfilling a task of this type, now the backfill will wait on the pool to have slots open up before running the task even though we don't need to do this if backfilling on a different host outside of the pool. I think breaking this use case is OK since the use case is a hack due to not having a proper resource isolation solution (e.g. mesos should be used in this case instead).\n- To make things less confusing for users, force running a task will now override/ignore:\n  - task instance's pool being full\n  - execution date for a task instance being in the future\n  - a task instance being in the retry waiting period\n  - the task instance's task ending prior to the task instance's execution date\n  - task instance is already queued\n  - task instance has already succeeded\n  - task instance is in the shutdown state\n  - WILL NOT OVERRIDE task instance is already running\n- SLA miss emails will now include all tasks that did not finish for a particular DAG run, even if the tasks didn't run because depends_on_past was not met for a task\n- Failed tasks will no longer be considered \"runnable\", they must be force-run or cleared first from the UI to be run, just like successful tasks\n\nI can revert these changes in behavior but it will make the code messier and I think it's a huge win to be consistent (both for code simplicity and for intuitiveness for users) across the board as much as possible when the question \"should this task be run right now?\" is asked.\n\n**Future Work (will not be released in the first version)**\n- Show one more dagrun in the tree view (even when that dagrun's execution date hasn't occured yet) so that users can see why task instances in the next dagrun are blocked. I wanted to include this in the first release but it's non-trivial to do (one way to solve this is to generate DAG runs before their execution date occurs).\n- Break down failed dependency explanations better (e.g. if the trigger rules requiring all upstream task successes fails, indicate the specific upstream tasks that failed)\n- Make failing dependencies for task instances more visible to users (e.g. asyncrhonously display failing dependencies when mousing over a task instance in the tree view).\n- Parallelize task instance dependency checking.\n- Indicate that a task isn't running because it was manually cleared: if a task is manually cleared the scheduler won't automatically rerun it, but there is no way of knowing this for sure without some kind of flag that marks the task state as cleared.\n- Can potentially add tips to fix a failing dependency in the new view that shows failed task instance dependencies (e.g. for \"depends_on_past\" when the last task state is failing we can give the tip to get this task to succeed, or even provide a button to clear it right from that view)\n- Additional task instance dependencies, e.g. there are no schedulers running (a task can't get scheduled until a scheduler is running), or the airflow scheduler queue is backed up\n- Forcing tasks in the UI should give users feedback on why their task didn't get forced (e.g. task was already running)\n- Keep history of changes to blocked dependencies that are accessible via the UI (this is useful to know why a task's execution was delayed)\n\n@mistercrunch @jlowin @plypaul \n",
  "created_at": "2016-04-26T23:09:30Z",
  "updated_at": "2017-01-04T15:48:10Z",
  "closed_at": "2016-05-19T21:05:31Z",
  "merged_at": null,
  "merge_commit_sha": null,
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/airflow/pulls/1435/commits",
  "review_comments_url": "https://api.github.com/repos/apache/airflow/pulls/1435/comments",
  "review_comment_url": "https://api.github.com/repos/apache/airflow/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/airflow/issues/1435/comments",
  "statuses_url": "https://api.github.com/repos/apache/airflow/statuses/c26c79867f280745aa5ce068a0041703ee41953f",
  "head": {
    "label": "apache:ddavydov/why_isnt_my_task_running_view",
    "ref": "ddavydov/why_isnt_my_task_running_view",
    "sha": "c26c79867f280745aa5ce068a0041703ee41953f",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 33884891,
      "node_id": "MDEwOlJlcG9zaXRvcnkzMzg4NDg5MQ==",
      "name": "airflow",
      "full_name": "apache/airflow",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/airflow",
      "description": "Apache Airflow - A platform to programmatically author, schedule, and monitor workflows",
      "fork": false,
      "url": "https://api.github.com/repos/apache/airflow",
      "forks_url": "https://api.github.com/repos/apache/airflow/forks",
      "keys_url": "https://api.github.com/repos/apache/airflow/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/airflow/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/airflow/teams",
      "hooks_url": "https://api.github.com/repos/apache/airflow/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/airflow/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/airflow/events",
      "assignees_url": "https://api.github.com/repos/apache/airflow/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/airflow/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/airflow/tags",
      "blobs_url": "https://api.github.com/repos/apache/airflow/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/airflow/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/airflow/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/airflow/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/airflow/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/airflow/languages",
      "stargazers_url": "https://api.github.com/repos/apache/airflow/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/airflow/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/airflow/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/airflow/subscription",
      "commits_url": "https://api.github.com/repos/apache/airflow/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/airflow/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/airflow/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/airflow/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/airflow/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/airflow/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/airflow/merges",
      "archive_url": "https://api.github.com/repos/apache/airflow/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/airflow/downloads",
      "issues_url": "https://api.github.com/repos/apache/airflow/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/airflow/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/airflow/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/airflow/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/airflow/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/airflow/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/airflow/deployments",
      "created_at": "2015-04-13T18:04:58Z",
      "updated_at": "2022-12-26T15:41:18Z",
      "pushed_at": "2022-12-26T22:34:47Z",
      "git_url": "git://github.com/apache/airflow.git",
      "ssh_url": "git@github.com:apache/airflow.git",
      "clone_url": "https://github.com/apache/airflow.git",
      "svn_url": "https://github.com/apache/airflow",
      "homepage": "https://airflow.apache.org/",
      "size": 206740,
      "stargazers_count": 28549,
      "watchers_count": 28549,
      "language": "Python",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": true,
      "forks_count": 11719,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 883,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "airflow",
        "apache",
        "apache-airflow",
        "hacktoberfest",
        "python",
        "scheduler",
        "workflow"
      ],
      "visibility": "public",
      "forks": 11719,
      "open_issues": 883,
      "watchers": 28549,
      "default_branch": "main"
    }
  },
  "base": {
    "label": "apache:master",
    "ref": "master",
    "sha": "f1ff65c8cde913fd9bfa8b21f83c7300b8b0effd",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 33884891,
      "node_id": "MDEwOlJlcG9zaXRvcnkzMzg4NDg5MQ==",
      "name": "airflow",
      "full_name": "apache/airflow",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/airflow",
      "description": "Apache Airflow - A platform to programmatically author, schedule, and monitor workflows",
      "fork": false,
      "url": "https://api.github.com/repos/apache/airflow",
      "forks_url": "https://api.github.com/repos/apache/airflow/forks",
      "keys_url": "https://api.github.com/repos/apache/airflow/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/airflow/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/airflow/teams",
      "hooks_url": "https://api.github.com/repos/apache/airflow/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/airflow/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/airflow/events",
      "assignees_url": "https://api.github.com/repos/apache/airflow/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/airflow/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/airflow/tags",
      "blobs_url": "https://api.github.com/repos/apache/airflow/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/airflow/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/airflow/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/airflow/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/airflow/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/airflow/languages",
      "stargazers_url": "https://api.github.com/repos/apache/airflow/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/airflow/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/airflow/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/airflow/subscription",
      "commits_url": "https://api.github.com/repos/apache/airflow/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/airflow/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/airflow/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/airflow/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/airflow/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/airflow/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/airflow/merges",
      "archive_url": "https://api.github.com/repos/apache/airflow/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/airflow/downloads",
      "issues_url": "https://api.github.com/repos/apache/airflow/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/airflow/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/airflow/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/airflow/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/airflow/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/airflow/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/airflow/deployments",
      "created_at": "2015-04-13T18:04:58Z",
      "updated_at": "2022-12-26T15:41:18Z",
      "pushed_at": "2022-12-26T22:34:47Z",
      "git_url": "git://github.com/apache/airflow.git",
      "ssh_url": "git@github.com:apache/airflow.git",
      "clone_url": "https://github.com/apache/airflow.git",
      "svn_url": "https://github.com/apache/airflow",
      "homepage": "https://airflow.apache.org/",
      "size": 206740,
      "stargazers_count": 28549,
      "watchers_count": 28549,
      "language": "Python",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": true,
      "forks_count": 11719,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 883,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "airflow",
        "apache",
        "apache-airflow",
        "hacktoberfest",
        "python",
        "scheduler",
        "workflow"
      ],
      "visibility": "public",
      "forks": 11719,
      "open_issues": 883,
      "watchers": 28549,
      "default_branch": "main"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/airflow/pulls/1435"
    },
    "html": {
      "href": "https://github.com/apache/airflow/pull/1435"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/airflow/issues/1435"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/airflow/issues/1435/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/airflow/pulls/1435/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/airflow/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/airflow/pulls/1435/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/airflow/statuses/c26c79867f280745aa5ce068a0041703ee41953f"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": false,
  "rebaseable": false,
  "mergeable_state": "dirty",
  "merged_by": null,
  "comments": 11,
  "review_comments": 10,
  "maintainer_can_modify": false,
  "commits": 8,
  "additions": 723,
  "deletions": 325,
  "changed_files": 8
}