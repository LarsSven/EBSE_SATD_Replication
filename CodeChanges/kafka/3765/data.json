{
  "url": "https://api.github.com/repos/apache/kafka/pulls/3765",
  "id": 138595037,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MTM4NTk1MDM3",
  "html_url": "https://github.com/apache/kafka/pull/3765",
  "diff_url": "https://github.com/apache/kafka/pull/3765.diff",
  "patch_url": "https://github.com/apache/kafka/pull/3765.patch",
  "issue_url": "https://api.github.com/repos/apache/kafka/issues/3765",
  "number": 3765,
  "state": "closed",
  "locked": false,
  "title": "KAFKA-5642: Use async ZookeeperClient in Controller",
  "user": {
    "login": "onurkaraman",
    "id": 529976,
    "node_id": "MDQ6VXNlcjUyOTk3Ng==",
    "avatar_url": "https://avatars.githubusercontent.com/u/529976?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/onurkaraman",
    "html_url": "https://github.com/onurkaraman",
    "followers_url": "https://api.github.com/users/onurkaraman/followers",
    "following_url": "https://api.github.com/users/onurkaraman/following{/other_user}",
    "gists_url": "https://api.github.com/users/onurkaraman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/onurkaraman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/onurkaraman/subscriptions",
    "organizations_url": "https://api.github.com/users/onurkaraman/orgs",
    "repos_url": "https://api.github.com/users/onurkaraman/repos",
    "events_url": "https://api.github.com/users/onurkaraman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/onurkaraman/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "Kafka today uses ZkClient, a wrapper client around the raw Zookeeper client. This library only exposes synchronous apis to the user. Synchronous apis mean we must wait an entire round trip before doing the next operation.\r\n\r\nThis becomes problematic with partition-heavy clusters, as we find the controller spending a significant amount of time just sending many sequential reads and writes to zookeeper at the per-partition granularity. This especially becomes an issue during:\r\n- controller failover, where the newly elected controller effectively reads all zookeeper state.\r\n- broker failures and controlled shutdown. The controller tries to elect a new leader for partitions previously led by the broker. The controller also removes the broker from isr on partitions for which the broker was a follower. These all incur partition-granular reads and writes to zookeeper.\r\n\r\nAs a first step in addressing these issues, we built a low-level wrapper client called ZookeeperClient in KAFKA-5501 that encourages pipelined, asynchronous apis.\r\n\r\nThis patch converts the controller to use the async ZookeeperClient to improve controller failover, broker failure handling, and controlled shutdown times.\r\n\r\nSome notable changes made in this patch:\r\n- All ControllerEvents now defer access to zookeeper at processing time instead of enqueue time as was intended with the single-threaded event queue model patch from KAFKA-5028. This results in a fresh view of the zookeeper state by the time we process the event. This reverts the hacks from KAFKA-5502 and KAFKA-5879.\r\n- We refactored PartitionStateMachine and ReplicaStateMachine to process multiple partitions and replicas in batch rather than one-at-a-time so that we can send a batch of requests over to ZookeeperClient to pipeline.\r\n- We've decouple ZookeeperClient handler registration from watcher registration. Previously, these two were coupled, which meant handler registrations actually sent out a request to the zookeeper ensemble to do the actual watcher registration. In KafkaController.onControllerFailover, we register partition modification handlers (thereby registering watchers) and additionally lookup the partition assignments for every topic in the cluster. We can shave a bit of time off failover if we merge these two operations. We can do this by decoupling ZookeeperClient handler registration from watcher registration. This means ZookeeperClient's registration apis have been changed so that they are purely in-memory operations, and they only take effect when the client sends ExistsRequest, GetDataRequest, or GetChildrenRequest.\r\n- We've simplified the logic for updating LeaderAndIsr such that if we get a BADVERSION error code, the controller will now just retry in the next round by reading the new state and trying the update again. This simplifies logic when updating the partition leader epoch, removing replicas from isr, and electing leaders for partitions.\r\n- We've implemented KAFKA-5083: always leave the last surviving member of the ISR in ZK. This means that if people re-disabled unclean leader election, we can still try to elect the leader from the last in-sync replica.\r\n- ZookeeperClient's handlers have been changed so that their methods default to no-ops for convenience.\r\n- All znode paths and definitions for znode encoding and decoding have been consolidated as static methods in ZkData.scala.\r\n- The partition leader election algorithms have been refactored as pure functions so that they can be easily unit tested.\r\n- PartitionStateMachine and ReplicaStateMachine now have unit tests.",
  "created_at": "2017-08-31T07:10:10Z",
  "updated_at": "2017-11-01T12:26:22Z",
  "closed_at": "2017-10-18T16:16:52Z",
  "merged_at": null,
  "merge_commit_sha": "102caa2ae58c17b7ab4e00b9e338e63c1cce1a5e",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/kafka/pulls/3765/commits",
  "review_comments_url": "https://api.github.com/repos/apache/kafka/pulls/3765/comments",
  "review_comment_url": "https://api.github.com/repos/apache/kafka/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/kafka/issues/3765/comments",
  "statuses_url": "https://api.github.com/repos/apache/kafka/statuses/70576977489654260ca951c2271e8e6f7ebcf205",
  "head": {
    "label": "onurkaraman:KAFKA-5642",
    "ref": "KAFKA-5642",
    "sha": "70576977489654260ca951c2271e8e6f7ebcf205",
    "user": {
      "login": "onurkaraman",
      "id": 529976,
      "node_id": "MDQ6VXNlcjUyOTk3Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/529976?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onurkaraman",
      "html_url": "https://github.com/onurkaraman",
      "followers_url": "https://api.github.com/users/onurkaraman/followers",
      "following_url": "https://api.github.com/users/onurkaraman/following{/other_user}",
      "gists_url": "https://api.github.com/users/onurkaraman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onurkaraman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onurkaraman/subscriptions",
      "organizations_url": "https://api.github.com/users/onurkaraman/orgs",
      "repos_url": "https://api.github.com/users/onurkaraman/repos",
      "events_url": "https://api.github.com/users/onurkaraman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onurkaraman/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 39984426,
      "node_id": "MDEwOlJlcG9zaXRvcnkzOTk4NDQyNg==",
      "name": "kafka",
      "full_name": "onurkaraman/kafka",
      "private": false,
      "owner": {
        "login": "onurkaraman",
        "id": 529976,
        "node_id": "MDQ6VXNlcjUyOTk3Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/529976?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/onurkaraman",
        "html_url": "https://github.com/onurkaraman",
        "followers_url": "https://api.github.com/users/onurkaraman/followers",
        "following_url": "https://api.github.com/users/onurkaraman/following{/other_user}",
        "gists_url": "https://api.github.com/users/onurkaraman/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/onurkaraman/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/onurkaraman/subscriptions",
        "organizations_url": "https://api.github.com/users/onurkaraman/orgs",
        "repos_url": "https://api.github.com/users/onurkaraman/repos",
        "events_url": "https://api.github.com/users/onurkaraman/events{/privacy}",
        "received_events_url": "https://api.github.com/users/onurkaraman/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/onurkaraman/kafka",
      "description": "Mirror of Apache Kafka",
      "fork": true,
      "url": "https://api.github.com/repos/onurkaraman/kafka",
      "forks_url": "https://api.github.com/repos/onurkaraman/kafka/forks",
      "keys_url": "https://api.github.com/repos/onurkaraman/kafka/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/onurkaraman/kafka/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/onurkaraman/kafka/teams",
      "hooks_url": "https://api.github.com/repos/onurkaraman/kafka/hooks",
      "issue_events_url": "https://api.github.com/repos/onurkaraman/kafka/issues/events{/number}",
      "events_url": "https://api.github.com/repos/onurkaraman/kafka/events",
      "assignees_url": "https://api.github.com/repos/onurkaraman/kafka/assignees{/user}",
      "branches_url": "https://api.github.com/repos/onurkaraman/kafka/branches{/branch}",
      "tags_url": "https://api.github.com/repos/onurkaraman/kafka/tags",
      "blobs_url": "https://api.github.com/repos/onurkaraman/kafka/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/onurkaraman/kafka/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/onurkaraman/kafka/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/onurkaraman/kafka/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/onurkaraman/kafka/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/onurkaraman/kafka/languages",
      "stargazers_url": "https://api.github.com/repos/onurkaraman/kafka/stargazers",
      "contributors_url": "https://api.github.com/repos/onurkaraman/kafka/contributors",
      "subscribers_url": "https://api.github.com/repos/onurkaraman/kafka/subscribers",
      "subscription_url": "https://api.github.com/repos/onurkaraman/kafka/subscription",
      "commits_url": "https://api.github.com/repos/onurkaraman/kafka/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/onurkaraman/kafka/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/onurkaraman/kafka/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/onurkaraman/kafka/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/onurkaraman/kafka/contents/{+path}",
      "compare_url": "https://api.github.com/repos/onurkaraman/kafka/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/onurkaraman/kafka/merges",
      "archive_url": "https://api.github.com/repos/onurkaraman/kafka/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/onurkaraman/kafka/downloads",
      "issues_url": "https://api.github.com/repos/onurkaraman/kafka/issues{/number}",
      "pulls_url": "https://api.github.com/repos/onurkaraman/kafka/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/onurkaraman/kafka/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/onurkaraman/kafka/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/onurkaraman/kafka/labels{/name}",
      "releases_url": "https://api.github.com/repos/onurkaraman/kafka/releases{/id}",
      "deployments_url": "https://api.github.com/repos/onurkaraman/kafka/deployments",
      "created_at": "2015-07-31T03:20:01Z",
      "updated_at": "2019-02-20T02:03:00Z",
      "pushed_at": "2019-02-20T02:02:30Z",
      "git_url": "git://github.com/onurkaraman/kafka.git",
      "ssh_url": "git@github.com:onurkaraman/kafka.git",
      "clone_url": "https://github.com/onurkaraman/kafka.git",
      "svn_url": "https://github.com/onurkaraman/kafka",
      "homepage": null,
      "size": 74971,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "Java",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 0,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 0,
      "watchers": 0,
      "default_branch": "trunk"
    }
  },
  "base": {
    "label": "apache:trunk",
    "ref": "trunk",
    "sha": "5cc162f30eca28f699a622671669fefba56fb447",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 2211243,
      "node_id": "MDEwOlJlcG9zaXRvcnkyMjExMjQz",
      "name": "kafka",
      "full_name": "apache/kafka",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/kafka",
      "description": "Mirror of Apache Kafka",
      "fork": false,
      "url": "https://api.github.com/repos/apache/kafka",
      "forks_url": "https://api.github.com/repos/apache/kafka/forks",
      "keys_url": "https://api.github.com/repos/apache/kafka/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/kafka/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/kafka/teams",
      "hooks_url": "https://api.github.com/repos/apache/kafka/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/kafka/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/kafka/events",
      "assignees_url": "https://api.github.com/repos/apache/kafka/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/kafka/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/kafka/tags",
      "blobs_url": "https://api.github.com/repos/apache/kafka/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/kafka/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/kafka/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/kafka/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/kafka/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/kafka/languages",
      "stargazers_url": "https://api.github.com/repos/apache/kafka/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/kafka/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/kafka/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/kafka/subscription",
      "commits_url": "https://api.github.com/repos/apache/kafka/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/kafka/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/kafka/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/kafka/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/kafka/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/kafka/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/kafka/merges",
      "archive_url": "https://api.github.com/repos/apache/kafka/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/kafka/downloads",
      "issues_url": "https://api.github.com/repos/apache/kafka/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/kafka/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/kafka/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/kafka/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/kafka/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/kafka/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/kafka/deployments",
      "created_at": "2011-08-15T18:06:16Z",
      "updated_at": "2022-12-26T18:52:43Z",
      "pushed_at": "2022-12-26T09:06:09Z",
      "git_url": "git://github.com/apache/kafka.git",
      "ssh_url": "git@github.com:apache/kafka.git",
      "clone_url": "https://github.com/apache/kafka.git",
      "svn_url": "https://github.com/apache/kafka",
      "homepage": null,
      "size": 150940,
      "stargazers_count": 23789,
      "watchers_count": 23789,
      "language": "Java",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 12170,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1012,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "kafka",
        "scala"
      ],
      "visibility": "public",
      "forks": 12170,
      "open_issues": 1012,
      "watchers": 23789,
      "default_branch": "trunk"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/3765"
    },
    "html": {
      "href": "https://github.com/apache/kafka/pull/3765"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/kafka/issues/3765"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/kafka/issues/3765/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/3765/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/3765/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/kafka/statuses/70576977489654260ca951c2271e8e6f7ebcf205"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": false,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": null,
  "comments": 21,
  "review_comments": 176,
  "maintainer_can_modify": false,
  "commits": 1,
  "additions": 3163,
  "deletions": 1609,
  "changed_files": 20
}