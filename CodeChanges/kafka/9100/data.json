{
  "url": "https://api.github.com/repos/apache/kafka/pulls/9100",
  "id": 458697672,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NDU4Njk3Njcy",
  "html_url": "https://github.com/apache/kafka/pull/9100",
  "diff_url": "https://github.com/apache/kafka/pull/9100.diff",
  "patch_url": "https://github.com/apache/kafka/pull/9100.patch",
  "issue_url": "https://api.github.com/repos/apache/kafka/issues/9100",
  "number": 9100,
  "state": "closed",
  "locked": false,
  "title": "Add AlterISR RPC and use it for ISR modifications",
  "user": {
    "login": "mumrah",
    "id": 55116,
    "node_id": "MDQ6VXNlcjU1MTE2",
    "avatar_url": "https://avatars.githubusercontent.com/u/55116?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mumrah",
    "html_url": "https://github.com/mumrah",
    "followers_url": "https://api.github.com/users/mumrah/followers",
    "following_url": "https://api.github.com/users/mumrah/following{/other_user}",
    "gists_url": "https://api.github.com/users/mumrah/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mumrah/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mumrah/subscriptions",
    "organizations_url": "https://api.github.com/users/mumrah/orgs",
    "repos_url": "https://api.github.com/users/mumrah/repos",
    "events_url": "https://api.github.com/users/mumrah/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mumrah/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "# Background\r\n\r\nOn the broker side, ISR changes in the following cases:\r\n* Follow catches up to the leader, we expand the ISR\r\n* On a timer, we check for followers which have fallen out of sync, we shrink the ISR\r\n\r\nPreviously, we would synchronously update the partition state in ZK which includes the current leader+epoch as well as the ISR. The ZK version is used for concurrency control and is known to the broker (kept in LeaderAndIsr struct). In order to notify the controller of the ISR changes, the leader would periodically write to a special \"isr_change_notification\" znode which the controlled kept a ZK watch on. A list of modified partitions was written to this znode so the controller would only reload the necessary ISRs.\r\n\r\nWith [KIP-497](https://cwiki.apache.org/confluence/display/KAFKA/KIP-497%3A+Add+inter-broker+API+to+alter+ISR), we introduce an asynchronous ISR workflow that makes the controller the only component which can change the ISR state.\r\n\r\n# TLDR\r\n\r\n* ISR updates are now sent asynchronously to the controller\r\n* ISRs are now only persisted by the controller \r\n* Leader can immediately assume a larger ISR during ISR expansion\r\n* No more ZK watch mechanism for ISR propagation\r\n* Gated behind IBP 2.7-IV2\r\n\r\n# Broker changes\r\n\r\nNow when the broker wants to modify the ISR, it will send an AlterIsr request to the controller. Since this request can include any number of partition's ISR modifications, we will want to allow batching of ISR updates. This is done by adding a small delay (50ms) before sending the request to the controller after an ISR change is requested. By adding this delay, other ISR changes can accumulate before getting sent off as a single AlterIsr request. \r\n\r\nOnce the controller makes the update, it will return the updated ISR to the leader and send UpdateMetadata requests to the other interested brokers. As specified in the KIP, while a leader is waiting on the controller to respond it will assume the largest ISR (i.e., the union of the actual ISR and the pending ISR). For ISR expansions, this allows the leader to assume the new ISR right away. For ISR shrinks however, the leader must wait for confirmation from the controller that the ISR has been persisted (see the KIP for more details). We call this oversubscribed ISR the \"maximal\" ISR\r\n\r\nA new `AlterIsrManager` class is added which accumulates ISR changes and uses a background `BrokerToControllerChannelManager` thread to send AlterIsr requests to the controller.\r\n\r\nThe use of AlterIsr is only enabled when a broker is configured with IBP version 2.7-IV2 or greater.\r\n\r\n# Controller changes\r\n\r\nA new `AlterIsrReceived` controller event is added along with supporting methods for handling AlterIsr requests from KafkaApis as well as actually processing the request and modifying ZooKeeper. The proposed ISRs are validated against the controller's metadata before writing to ZK. Once all of the ISRs have been written out (or failed), the controller will return the AlterIsr response which includes the updated ISRs and zk versions.\r\n\r\nAfter returning the response, the controller will then send out UpdateMetadata requests for all partitions included in the AlterIsr request.\r\n\r\nIn order to support rolling upgrades and brokers on older IBP, the controller will accept AlterIsr and monitor the ZK watch for ISR changes. Once we fully migrate away from ZK, AlterIsr will be the only mechanism for updating the ISR.\r\n\r\n# Configs\r\n\r\nTODO \r\n\r\n# Metrics\r\n\r\nTODO\r\n\r\n",
  "created_at": "2020-07-29T21:05:27Z",
  "updated_at": "2020-11-18T03:15:10Z",
  "closed_at": "2020-09-24T23:28:26Z",
  "merged_at": "2020-09-24T23:28:26Z",
  "merge_commit_sha": "57de67db22eb373f92ec5dd449d317ed2bc8b8d1",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/apache/kafka/pulls/9100/commits",
  "review_comments_url": "https://api.github.com/repos/apache/kafka/pulls/9100/comments",
  "review_comment_url": "https://api.github.com/repos/apache/kafka/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/apache/kafka/issues/9100/comments",
  "statuses_url": "https://api.github.com/repos/apache/kafka/statuses/ac3eec11505bace6c3302ad982d6418d30f26313",
  "head": {
    "label": "mumrah:KAFKA-8836-alter-isr",
    "ref": "KAFKA-8836-alter-isr",
    "sha": "ac3eec11505bace6c3302ad982d6418d30f26313",
    "user": {
      "login": "mumrah",
      "id": 55116,
      "node_id": "MDQ6VXNlcjU1MTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/55116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mumrah",
      "html_url": "https://github.com/mumrah",
      "followers_url": "https://api.github.com/users/mumrah/followers",
      "following_url": "https://api.github.com/users/mumrah/following{/other_user}",
      "gists_url": "https://api.github.com/users/mumrah/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mumrah/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mumrah/subscriptions",
      "organizations_url": "https://api.github.com/users/mumrah/orgs",
      "repos_url": "https://api.github.com/users/mumrah/repos",
      "events_url": "https://api.github.com/users/mumrah/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mumrah/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 5542805,
      "node_id": "MDEwOlJlcG9zaXRvcnk1NTQyODA1",
      "name": "kafka",
      "full_name": "mumrah/kafka",
      "private": false,
      "owner": {
        "login": "mumrah",
        "id": 55116,
        "node_id": "MDQ6VXNlcjU1MTE2",
        "avatar_url": "https://avatars.githubusercontent.com/u/55116?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mumrah",
        "html_url": "https://github.com/mumrah",
        "followers_url": "https://api.github.com/users/mumrah/followers",
        "following_url": "https://api.github.com/users/mumrah/following{/other_user}",
        "gists_url": "https://api.github.com/users/mumrah/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mumrah/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mumrah/subscriptions",
        "organizations_url": "https://api.github.com/users/mumrah/orgs",
        "repos_url": "https://api.github.com/users/mumrah/repos",
        "events_url": "https://api.github.com/users/mumrah/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mumrah/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/mumrah/kafka",
      "description": "Mirror of Apache Kafka",
      "fork": true,
      "url": "https://api.github.com/repos/mumrah/kafka",
      "forks_url": "https://api.github.com/repos/mumrah/kafka/forks",
      "keys_url": "https://api.github.com/repos/mumrah/kafka/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/mumrah/kafka/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/mumrah/kafka/teams",
      "hooks_url": "https://api.github.com/repos/mumrah/kafka/hooks",
      "issue_events_url": "https://api.github.com/repos/mumrah/kafka/issues/events{/number}",
      "events_url": "https://api.github.com/repos/mumrah/kafka/events",
      "assignees_url": "https://api.github.com/repos/mumrah/kafka/assignees{/user}",
      "branches_url": "https://api.github.com/repos/mumrah/kafka/branches{/branch}",
      "tags_url": "https://api.github.com/repos/mumrah/kafka/tags",
      "blobs_url": "https://api.github.com/repos/mumrah/kafka/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/mumrah/kafka/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/mumrah/kafka/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/mumrah/kafka/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/mumrah/kafka/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/mumrah/kafka/languages",
      "stargazers_url": "https://api.github.com/repos/mumrah/kafka/stargazers",
      "contributors_url": "https://api.github.com/repos/mumrah/kafka/contributors",
      "subscribers_url": "https://api.github.com/repos/mumrah/kafka/subscribers",
      "subscription_url": "https://api.github.com/repos/mumrah/kafka/subscription",
      "commits_url": "https://api.github.com/repos/mumrah/kafka/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/mumrah/kafka/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/mumrah/kafka/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/mumrah/kafka/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/mumrah/kafka/contents/{+path}",
      "compare_url": "https://api.github.com/repos/mumrah/kafka/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/mumrah/kafka/merges",
      "archive_url": "https://api.github.com/repos/mumrah/kafka/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/mumrah/kafka/downloads",
      "issues_url": "https://api.github.com/repos/mumrah/kafka/issues{/number}",
      "pulls_url": "https://api.github.com/repos/mumrah/kafka/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/mumrah/kafka/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/mumrah/kafka/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/mumrah/kafka/labels{/name}",
      "releases_url": "https://api.github.com/repos/mumrah/kafka/releases{/id}",
      "deployments_url": "https://api.github.com/repos/mumrah/kafka/deployments",
      "created_at": "2012-08-24T16:22:00Z",
      "updated_at": "2018-12-10T19:34:54Z",
      "pushed_at": "2022-12-22T00:47:30Z",
      "git_url": "git://github.com/mumrah/kafka.git",
      "ssh_url": "git@github.com:mumrah/kafka.git",
      "clone_url": "https://github.com/mumrah/kafka.git",
      "svn_url": "https://github.com/mumrah/kafka",
      "homepage": null,
      "size": 145394,
      "stargazers_count": 2,
      "watchers_count": 2,
      "language": "Java",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 2,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [],
      "visibility": "public",
      "forks": 2,
      "open_issues": 1,
      "watchers": 2,
      "default_branch": "trunk"
    }
  },
  "base": {
    "label": "apache:trunk",
    "ref": "trunk",
    "sha": "e9251a11dc60122893c7bcfb2be36c3cd0521902",
    "user": {
      "login": "apache",
      "id": 47359,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apache",
      "html_url": "https://github.com/apache",
      "followers_url": "https://api.github.com/users/apache/followers",
      "following_url": "https://api.github.com/users/apache/following{/other_user}",
      "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
      "organizations_url": "https://api.github.com/users/apache/orgs",
      "repos_url": "https://api.github.com/users/apache/repos",
      "events_url": "https://api.github.com/users/apache/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apache/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 2211243,
      "node_id": "MDEwOlJlcG9zaXRvcnkyMjExMjQz",
      "name": "kafka",
      "full_name": "apache/kafka",
      "private": false,
      "owner": {
        "login": "apache",
        "id": 47359,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ3MzU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/47359?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/apache",
        "html_url": "https://github.com/apache",
        "followers_url": "https://api.github.com/users/apache/followers",
        "following_url": "https://api.github.com/users/apache/following{/other_user}",
        "gists_url": "https://api.github.com/users/apache/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/apache/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/apache/subscriptions",
        "organizations_url": "https://api.github.com/users/apache/orgs",
        "repos_url": "https://api.github.com/users/apache/repos",
        "events_url": "https://api.github.com/users/apache/events{/privacy}",
        "received_events_url": "https://api.github.com/users/apache/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/apache/kafka",
      "description": "Mirror of Apache Kafka",
      "fork": false,
      "url": "https://api.github.com/repos/apache/kafka",
      "forks_url": "https://api.github.com/repos/apache/kafka/forks",
      "keys_url": "https://api.github.com/repos/apache/kafka/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/apache/kafka/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/apache/kafka/teams",
      "hooks_url": "https://api.github.com/repos/apache/kafka/hooks",
      "issue_events_url": "https://api.github.com/repos/apache/kafka/issues/events{/number}",
      "events_url": "https://api.github.com/repos/apache/kafka/events",
      "assignees_url": "https://api.github.com/repos/apache/kafka/assignees{/user}",
      "branches_url": "https://api.github.com/repos/apache/kafka/branches{/branch}",
      "tags_url": "https://api.github.com/repos/apache/kafka/tags",
      "blobs_url": "https://api.github.com/repos/apache/kafka/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/apache/kafka/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/apache/kafka/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/apache/kafka/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/apache/kafka/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/apache/kafka/languages",
      "stargazers_url": "https://api.github.com/repos/apache/kafka/stargazers",
      "contributors_url": "https://api.github.com/repos/apache/kafka/contributors",
      "subscribers_url": "https://api.github.com/repos/apache/kafka/subscribers",
      "subscription_url": "https://api.github.com/repos/apache/kafka/subscription",
      "commits_url": "https://api.github.com/repos/apache/kafka/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/apache/kafka/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/apache/kafka/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/apache/kafka/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/apache/kafka/contents/{+path}",
      "compare_url": "https://api.github.com/repos/apache/kafka/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/apache/kafka/merges",
      "archive_url": "https://api.github.com/repos/apache/kafka/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/apache/kafka/downloads",
      "issues_url": "https://api.github.com/repos/apache/kafka/issues{/number}",
      "pulls_url": "https://api.github.com/repos/apache/kafka/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/apache/kafka/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/apache/kafka/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/apache/kafka/labels{/name}",
      "releases_url": "https://api.github.com/repos/apache/kafka/releases{/id}",
      "deployments_url": "https://api.github.com/repos/apache/kafka/deployments",
      "created_at": "2011-08-15T18:06:16Z",
      "updated_at": "2022-12-26T18:52:43Z",
      "pushed_at": "2022-12-26T09:06:09Z",
      "git_url": "git://github.com/apache/kafka.git",
      "ssh_url": "git@github.com:apache/kafka.git",
      "clone_url": "https://github.com/apache/kafka.git",
      "svn_url": "https://github.com/apache/kafka",
      "homepage": null,
      "size": 150940,
      "stargazers_count": 23789,
      "watchers_count": 23789,
      "language": "Java",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": false,
      "has_pages": false,
      "has_discussions": false,
      "forks_count": 12170,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1012,
      "license": {
        "key": "apache-2.0",
        "name": "Apache License 2.0",
        "spdx_id": "Apache-2.0",
        "url": "https://api.github.com/licenses/apache-2.0",
        "node_id": "MDc6TGljZW5zZTI="
      },
      "allow_forking": true,
      "is_template": false,
      "web_commit_signoff_required": false,
      "topics": [
        "kafka",
        "scala"
      ],
      "visibility": "public",
      "forks": 12170,
      "open_issues": 1012,
      "watchers": 23789,
      "default_branch": "trunk"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/9100"
    },
    "html": {
      "href": "https://github.com/apache/kafka/pull/9100"
    },
    "issue": {
      "href": "https://api.github.com/repos/apache/kafka/issues/9100"
    },
    "comments": {
      "href": "https://api.github.com/repos/apache/kafka/issues/9100/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/9100/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/apache/kafka/pulls/9100/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/apache/kafka/statuses/ac3eec11505bace6c3302ad982d6418d30f26313"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": true,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": {
    "login": "hachikuji",
    "id": 12502538,
    "node_id": "MDQ6VXNlcjEyNTAyNTM4",
    "avatar_url": "https://avatars.githubusercontent.com/u/12502538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hachikuji",
    "html_url": "https://github.com/hachikuji",
    "followers_url": "https://api.github.com/users/hachikuji/followers",
    "following_url": "https://api.github.com/users/hachikuji/following{/other_user}",
    "gists_url": "https://api.github.com/users/hachikuji/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hachikuji/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hachikuji/subscriptions",
    "organizations_url": "https://api.github.com/users/hachikuji/orgs",
    "repos_url": "https://api.github.com/users/hachikuji/repos",
    "events_url": "https://api.github.com/users/hachikuji/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hachikuji/received_events",
    "type": "User",
    "site_admin": false
  },
  "comments": 7,
  "review_comments": 168,
  "maintainer_can_modify": false,
  "commits": 47,
  "additions": 1533,
  "deletions": 201,
  "changed_files": 35
}